<!--The html template was heavily edited using AI Generated Code -->
{% load static %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>{{ group.name }} - Groups - Calibration</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="{% static 'css/base.css' %}">
  <style>
    :root { --pane-h: min(78vh, 680px); }

    .profile-button {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      background: #FFFFFF;
      border: 1px solid var(--border-subtle);
      box-shadow: 0 6px 16px rgba(2, 54, 83, 0.08);
      transition: background 0.16s ease, box-shadow 0.16s ease, transform 0.12s ease, border-color 0.12s ease;
    }
    .profile-button:hover {
      background: var(--card-soft);
      border-color: var(--accent-soft);
      box-shadow: 0 10px 22px rgba(2, 54, 83, 0.16);
      transform: translateY(-1px);
    }
    .avatar-wrap { width: 32px; height: 32px; border-radius: 999px; overflow: hidden; background: #D1D5DB; flex-shrink: 0; }
    .avatar-wrap img { width: 100%; height: 100%; object-fit: cover; }
    .gear-icon { font-size: 18px; color: var(--accent); }

    /* === GROUP HERO (like Community hero but slimmer) === */
    .group-hero {
      border-radius: var(--radius-lg);
      padding: 16px 16px 14px;
      background:
        radial-gradient(circle at 0 0, #C3E4E9 0, #023653 55%, #012132 100%);
      color: #E9F4F7;
      box-shadow: 0 22px 60px rgba(1, 24, 39, 0.55);
      border: 1px solid rgba(1, 38, 63, 0.9);
      display: flex;
      justify-content: space-between;
      gap: 18px;
      flex-wrap: wrap;
      align-items: flex-start;
    }

    .group-hero-main h2 {
      margin: 0;
      font-size: 1.05rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
    }

    .group-hero-main p {
      margin: 6px 0 0;
      font-size: 0.88rem;
      max-width: 520px;
      color: #D5E4EA;
    }

    .group-hero-meta {
      font-size: 0.78rem;
      margin-top: 6px;
      color: #BED9E5;
    }

    .group-hero-actions {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 8px;
    }

    .group-status-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(34, 197, 94, 0.12);
      border: 1px solid rgba(74, 222, 128, 0.7);
      font-size: 0.78rem;
      color: #bbf7d0;
    }

    .group-status-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #22c55e;
    }

    .group-hero-actions form,
    .group-hero-actions a {
      width: 100%;
    }

    /* === GROUP MAIN (like Messages 3-pane) === */
    .group-shell {
      border-radius: var(--radius-lg);
      padding: 14px;
      background:
        radial-gradient(circle at top left, rgba(136, 180, 190, 0.2), transparent 55%),
        radial-gradient(circle at bottom right, rgba(2, 54, 83, 0.12), transparent 55%),
        rgba(250, 252, 255, 0.96);
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(2, 54, 83, 0.18);
    }

    .group-main-grid {
      display: grid;
      grid-template-columns: 260px minmax(0, 1.8fr) 260px;
      min-height: var(--pane-h);
      gap: 10px;
    }
    @media (max-width: 1100px) {
      .group-main-grid {
        grid-template-columns: 240px minmax(0, 1.6fr);
        grid-template-areas:
          "left center"
          "left right";
      }
      .pane-left { grid-area: left; }
      .pane-center { grid-area: center; }
      .pane-right { grid-area: right; }
    }

    @media (max-width: 800px) {
      .group-main-grid {
        grid-template-columns: minmax(0, 1fr);
        grid-template-areas:
          "center"
          "left"
          "right";
      }
    }

    .pane {
      display: flex;
      flex-direction: column;
      min-height: 0;
      border-radius: 16px;
      background: rgba(255, 255, 255, 0.96);
      border: 1px solid rgba(197, 212, 216, 0.9);
      backdrop-filter: blur(10px);
      overflow: hidden;
    }

    .pane-left {
      background: linear-gradient(180deg, var(--card-soft) 0%, #F7FCFE 100%);
    }

    .pane-center {
      background: radial-gradient(circle at top, var(--bg-soft) 0, #FFFFFF 55%, #F7FCFE 100%);
    }

    .pane-right {
      background: linear-gradient(180deg, var(--card-soft) 0%, #E5F6F8 100%);
    }

    /* LEFT PANE: group info + members */
    .pane-left-header {
      padding: 10px 14px;
      border-bottom: 1px solid var(--border-subtle);
      font-size: 0.86rem;
      font-weight: 600;
    }

    .group-info-block {
      padding: 10px 14px;
      border-bottom: 1px solid var(--border-subtle);
      font-size: 0.8rem;
    }

    .group-info-label {
      font-size: 0.72rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-bottom: 3px;
    }

    .group-members-list {
      list-style: none;
      margin: 0;
      padding: 8px 10px 10px 14px;
      flex: 1;
      overflow-y: auto;
      font-size: 0.8rem;
    }

    .group-member-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 4px;
      border-radius: 10px;
      transition: background 0.12s, transform 0.1s;
    }

    .group-member-item:hover {
      background: rgba(5, 108, 137, 0.08);
      transform: translateY(-1px);
    }

    .member-avatar {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      background: rgba(5, 108, 137, 0.12);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.76rem;
      font-weight: 600;
      color: var(--accent-strong);
      flex-shrink: 0;
    }

    .member-name {
      font-weight: 600;
    }

    /* CENTER PANE: threads (Community-style) */
    .pane-center-header {
      padding: 10px 16px;
      border-bottom: 1px solid var(--border-subtle);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      background: rgba(255, 255, 255, 0.96);
    }

    .pane-center-header h3 {
      margin: 0;
      font-size: 0.9rem;
      letter-spacing: 0.09em;
      text-transform: uppercase;
      color: var(--accent-strong);
    }

    .pane-center-header span {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .threads-scroll {
      flex: 1;
      padding: 10px 14px 10px 16px;
      overflow-y: auto;
      position: relative;
    }

    .thread-card {
      background: var(--card-soft);
      border-radius: 16px;
      border: 1px solid var(--border-subtle);
      padding: 13px 16px 10px;
      margin-bottom: 10px;
      box-shadow: 0 14px 34px rgba(2, 54, 83, 0.14);
      transition:
        transform 0.12s ease,
        box-shadow 0.15s ease,
        border-color 0.15s ease,
        background 0.15s ease;
    }

    .thread-card:hover {
      transform: translateY(-2px);
      border-color: var(--accent-soft);
      box-shadow: 0 18px 40px rgba(2, 54, 83, 0.2);
      background: #FFFFFF;
    }

    .thread-meta-row {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.78rem;
      color: var(--text-muted);
      margin-bottom: 4px;
      flex-wrap: wrap;
    }

    .meta-avatar {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      background: #E8F5F8;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--accent-strong);
      flex-shrink: 0;
    }

    .meta-dot {
      width: 4px;
      height: 4px;
      border-radius: 999px;
      background: #B7CED4;
    }

    .thread-title {
      margin: 0;
      font-size: 1rem;
      font-weight: 700;
      color: var(--accent-strong);
    }

    .thread-preview {
      margin: 6px 0 4px;
      font-size: 0.86rem;
      color: #325261;
      line-height: 1.5;
    }

    .thread-footer {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.8rem;
      color: #486777;
      margin-top: 2px;
      flex-wrap: wrap;
    }

    .thread-footer-spacer { flex: 1; }

    .inline-reply-form {
      margin-top: 8px;
      border-top: 1px solid var(--border-subtle);
      padding-top: 8px;
    }

    .inline-reply-form textarea {
      width: 100%;
      border: 1px solid var(--border-subtle);
      border-radius: 8px;
      padding: 6px 8px;
      font-size: 0.82rem;
      resize: vertical;
    }

    .empty {
      padding: 14px;
      border-radius: 12px;
      border: 1px dashed var(--border-subtle);
      background: #FFFFFF;
      color: #486777;
      font-size: 0.88rem;
    }

    /* RIGHT PANE: group chat (Messages-style) */
    .pane-right-header {
      padding: 10px 16px;
      border-bottom: 1px solid var(--border-subtle);
      font-size: 0.86rem;
      font-weight: 600;
      background: rgba(248, 252, 255, 0.96);
    }

    .chat-thread {
      flex: 1;
      padding: 10px 12px 12px 14px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 4px;
      position: relative;
    }

    .chat-thread::before {
      content: "";
      position: absolute;
      inset: 0;
      background-image:
        linear-gradient(120deg, rgba(136, 180, 190, 0.08) 1px, transparent 0),
        linear-gradient(210deg, rgba(136, 180, 190, 0.05) 1px, transparent 0);
      background-size: 26px 26px;
      opacity: 0.35;
      pointer-events: none;
    }

    .chat-thread-inner {
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .day-label-wrap {
      text-align: center;
      margin-bottom: 6px;
    }

    .day-label {
      display: inline-block;
      padding: 2px 9px;
      border-radius: 999px;
      background: rgba(2, 54, 83, 0.05);
      font-size: 0.7rem;
      color: #8CA1AA;
      backdrop-filter: blur(4px);
    }

    .message-row {
      display: flex;
      margin-bottom: 2px;
    }

    .message-row.me { justify-content: flex-end; }
    .message-row.them { justify-content: flex-start; }

    .message-bubble {
      max-width: 82%;
      border-radius: 16px;
      padding: 7px 10px 4px;
      font-size: 0.82rem;
      line-height: 1.4;
      background: rgba(248, 252, 255, 0.98);
      color: #111827;
      box-shadow: 0 5px 14px rgba(2, 54, 83, 0.25);
      position: relative;
      animation: bubbleIn 0.18s ease-out;
    }

    .message-bubble.me {
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
      color: #F9FAFB;
    }

    @keyframes bubbleIn {
      from { opacity: 0; transform: translateY(4px) scale(0.98); }
      to   { opacity: 1; transform: translateY(0) scale(1); }
    }

    .message-meta {
      display: flex;
      justify-content: flex-end;
      font-size: 0.7rem;
      opacity: 0.9;
      margin-top: 2px;
    }

    .chat-empty {
      font-size: 0.8rem;
      color: #6B7280;
      margin: 4px 0 0;
    }

    .chat-input-wrap {
      border-top: 1px solid var(--border-subtle);
      padding: 9px 12px;
      background: rgba(246, 250, 252, 0.96);
      backdrop-filter: blur(8px);
    }

    .chat-input-inner {
      display: flex;
      align-items: center;
      gap: 6px;
      border-radius: var(--radius-pill);
      border: 1px solid var(--border-subtle);
      background: #FFFFFF;
      padding: 4px 8px;
      box-shadow: 0 6px 16px rgba(2, 54, 83, 0.22);
    }

    .chat-input-inner textarea {
      flex: 1;
      border: none;
      background: transparent;
      outline: none;
      resize: none;
      padding: 6px 4px;
      font-size: 0.84rem;
      height: 38px;
      max-height: 90px;
      overflow-y: auto;
    }

    .icon-btn {
      border: none;
      background: none;
      cursor: pointer;
      font-size: 0.9rem;
      padding: 4px;
      opacity: 0.8;
      transition: opacity 0.12s;
    }

    .icon-btn:hover { opacity: 1; }

    .send-btn {
      border: none;
      border-radius: var(--radius-pill);
      padding: 6px 13px;
      background: var(--accent);
      color: #F2FBFF;
      font-size: 0.78rem;
      font-weight: 600;
      cursor: pointer;
      flex-shrink: 0;
      box-shadow: 0 8px 20px rgba(5, 108, 137, 0.45);
      transition: transform 0.1s, box-shadow 0.1s;
    }

    .send-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 24px rgba(5, 108, 137, 0.55);
    }

    
    /* PROFILE MODAL OVERRIDE */
    .profile-quick-links h4 { color: var(--accent-strong); }

</style>
</head>
<body>
<div class="app-shell">
  <!-- SIDEBAR -->
  <nav class="sidebar">
    <div class="brand">
      <div class="brand-mark">CB</div>
      <div class="brand-text">
        <div class="brand-title">Calibration</div>
        <div class="brand-subtitle">Discipline - Habits - Skills</div>
      </div>
    </div>

    <div class="nav">
      <a href="{% url 'dashboard' %}" class="nav-link">Dashboard</a>
      <a href="{% url 'disciplinebuilder' %}" class="nav-link">Discipline Builder</a>
      <a href="{% url 'progresstracker' %}" class="nav-link">Progress Tracker</a>
      <a href="{% url 'rewards' %}" class="nav-link">Rewards</a>
      <a href="{% url 'messages' %}" class="nav-link{% if has_unread_messages %} has-unread{% endif %}">Messages</a>
      <a href="{% url 'user_profile' %}" class="nav-link">Profile</a>
      <a href="{% url 'community' %}" class="nav-link">Community</a>
      <a href="{% url 'groups' %}" class="nav-link active">Groups</a>
      <a href="{% url 'buddies' %}" class="nav-link">Buddies</a>
    </div>
  </nav>

  <!-- MAIN -->
  <main class="site-main">
    <!-- HEADER -->
    <header class="site-header">
      <div class="site-header-title">
        <h1>{{ group.name|upper }}</h1>
        <span>Group Space - {{ group.member_count }} member{{ group.member_count|pluralize }}</span>
      </div>
      <div class="header-actions">
        <div class="toolbar">
          <button class="profile-button" id="profile-button">
            <span class="avatar-wrap">
              <img src="https://via.placeholder.com/40x40.png" alt="User avatar">
            </span>
            <span class="gear-icon">gear</span>
          </button>
          <a class="btn" href="{% url 'groups' %}">All groups</a>
          <a class="btn btn-primary" href="/accounts/logout/">Log out</a>
        </div>
      </div>
    </header>

    <!-- PROFILE MODAL -->
    <div class="modal-overlay" id="profile-modal" aria-hidden="true">
      <div class="modal">
        <div class="modal-header">
          <h3>Profile & Account</h3>
          <button type="button" class="modal-close" id="modal-close">&times;</button>
        </div>
        <div class="modal-body">
          <div class="profile-modal-layout">
            <article class="profile-card">
              <div class="profile-card-header">
                <p>Welcome back</p>
                <h4>{{ user.username }}</h4>
                <p class="profile-tagline">Manage your Calibration account and shortcuts.</p>
                <div class="profile-avatar-shell">
                  <img src="https://via.placeholder.com/80"
                       alt="Avatar for {{ user.username }}">
                </div>
              </div>
              <div class="profile-card-main">
                <div class="profile-detail-grid">
                  <div class="profile-detail-item">
                    <div class="profile-detail-label">Account</div>
                    <div class="profile-detail-value">Calibration Basic</div>
                  </div>
                  <div class="profile-detail-item">
                    <div class="profile-detail-label">Email</div>
                    <div class="profile-detail-value">
                      {{ user.email|default:"Not set" }}
                    </div>
                  </div>
                  <div class="profile-detail-item">
                    <div class="profile-detail-label">Member since</div>
                    <div class="profile-detail-value">
                      {{ user.date_joined|date:"M j, Y" }}
                    </div>
                  </div>
                  <div class="profile-detail-item">
                    <div class="profile-detail-label">Last login</div>
                    <div class="profile-detail-value">
                      {{ user.last_login|date:"M j, Y" }}
                    </div>
                  </div>
                </div>

                <div class="profile-quick-actions">
                  <a href="{% url 'user_profile' %}" class="p-btn p-btn-primary">View profile</a>
                  <a href="{% url 'user_settings' %}" class="p-btn p-btn-ghost">Account settings</a>
                  <a href="/accounts/logout/" class="p-btn p-btn-logout">Log out</a>
                </div>
              </div>
            </article>

            <section class="profile-quick-links">
              <h4>Shortcuts</h4>
              <ul>
                <li><a href="{% url 'skill_create' %}">Add a new skill</a></li>
                <li><a href="{% url 'habit_create' %}">Create a new habit</a></li>
                <li><a href="{% url 'rewards' %}">View your rewards</a></li>
              </ul>
              <p class="profile-footnote">
                Use the dashboard for day-to-day tracking; this space is for account details.
              </p>
            </section>
          </div>
        </div>
      </div>
    </div>

    <!-- GROUP HERO -->
    <section class="group-hero">
      <div class="group-hero-main">
        <h2>{{ group.name }}</h2>
        <p>{{ group.tagline|default:"Focus space for shared habits, skills, and goals." }}</p>
        <div class="group-hero-meta">
          {{ group.member_count }} member{{ group.member_count|pluralize }} - Created {{ group.created_at|date:"M j, Y" }}
        </div>
      </div>
      <div class="group-hero-actions">
        <div class="group-status-pill">
          <span class="group-status-dot"></span>
          Group space live
        </div>

        {% if group_is_member %}
          <form method="post" action="{% url 'group_leave' group.id %}">
            {% csrf_token %}
            <button type="submit" class="btn" style="width:100%;justify-content:center;background:#fee2e2;border-color:#fecdd3;color:#b91c1c;">
              Leave group
            </button>
          </form>
        {% else %}
          <form method="post" action="{% url 'group_join' group.id %}">
            {% csrf_token %}
            <button type="submit" class="btn btn-primary" style="width:100%;justify-content:center;">
              Join group
            </button>
          </form>
        {% endif %}
      </div>
    </section>

    <!-- GROUP MAIN (3 panes) -->
    <section class="group-shell">
      <div class="group-main-grid">
        <!-- LEFT: group info + members -->
        <aside class="pane pane-left">
          <div class="pane-left-header">
            Group Overview
          </div>

          <div class="group-info-block">
            <div class="group-info-label">Description</div>
            <div>{{ group.description|default:"No description yet. Use this space to define what this group is about." }}</div>
          </div>

          <div class="group-info-block">
            <div class="group-info-label">Your role</div>
            {% if group_is_owner %}
              <div>Owner - You can manage this group.</div>
            {% elif group_is_member %}
              <div>Member - You can post and join chat.</div>
            {% else %}
              <div>Not a member - Join to participate.</div>
            {% endif %}
          </div>

          <div class="pane-left-header" style="border-top:none;">
            Members ({{ group.member_count }})
          </div>

          <ul class="group-members-list">
            {% for m in group_members %}
              <li class="group-member-item">
                <div class="member-avatar">
                  {{ m.user.username|slice:":2"|upper }}
                </div>
                <div>
                  <div class="member-name">{{ m.user.username }}</div>
                  {% if m.user_id == user.id %}
                    <div style="font-size:0.72rem; color:var(--text-muted);">You</div>
                  {% endif %}
                </div>
              </li>
            {% empty %}
              <li class="group-member-item">
                <div>No members yet.</div>
              </li>
            {% endfor %}
          </ul>
        </aside>

        <!-- CENTER: group threads -->
        <section class="pane pane-center">
          <div class="pane-center-header">
            <div>
              <h3>Group threads</h3>
              <span>{{ group_threads|length }} discussion{{ group_threads|length|pluralize }}</span>
            </div>
            {% if group_is_member %}
              <button type="button" class="btn btn-primary" id="toggle-new-thread">+ New thread</button>
            {% endif %}
          </div>

          {% if group_is_member %}
          <form id="new-thread-form" class="inline-reply-form" method="post" action="{% url 'group_thread_create' group.id %}" style="margin: 0 16px 10px; display:none;">
            {% csrf_token %}
            <input type="text" name="title" placeholder="Thread title" required style="width:100%; border:1px solid var(--border-subtle); border-radius:8px; padding:6px 8px; margin-bottom:6px;">
            <textarea name="body" rows="3" placeholder="Share the first post..." required style="width:100%; border:1px solid var(--border-subtle); border-radius:8px; padding:6px 8px;"></textarea>
            <div style="margin-top:6px; display:flex; gap:6px; justify-content:flex-end;">
              <button type="button" class="btn inline-reply-cancel" data-thread="new" style="padding:4px 8px; font-size:0.78rem;">Cancel</button>
              <button type="submit" class="btn btn-primary" style="padding:4px 10px; font-size:0.78rem;">Post thread</button>
            </div>
          </form>
          {% endif %}

          <div class="threads-scroll">
            {% if group_threads %}
              {% for thread in group_threads %}
                <article class="thread-card">
                  <div class="thread-meta-row">
                    <div class="meta-avatar">
                      {{ thread.author.username|slice:":2"|upper }}
                    </div>
                    <span style="font-weight:600; font-size:0.8rem;">
                      {{ thread.author.username }}
                    </span>
                    <span class="meta-dot"></span>
                    <span>{{ thread.created_at|timesince }} ago</span>
                  </div>

                  <h3 class="thread-title">{{ thread.title }}</h3>
                  <p class="thread-preview">{{ thread.body|truncatechars:220 }}</p>

                    <div class="thread-footer">
                      <span>Comments {{ thread.comment_count|default:0 }}</span>
                      <div class="thread-footer-spacer"></div>
                    <a class="btn" href="{% url 'group_thread_detail' group.id thread.id %}" style="padding:3px 9px; font-size:0.78rem; background:#f1f5f9; border-color:#e2e8f0;">
                      Open
                    </a>
                    {% if group_is_member %}
                      <button type="button" class="btn inline-reply-toggle"
                              data-thread="{{ thread.id }}"
                              style="padding:3px 9px; font-size:0.78rem;">
                        Quick reply
                      </button>
                    {% endif %}
                  </div>

                  {% if group_is_member %}
                    <form method="post"
                          action="{% url 'group_thread_reply' group.id thread.id %}"
                          class="inline-reply-form"
                          data-thread="{{ thread.id }}"
                          style="display:none;">
                      {% csrf_token %}
                      <textarea name="body" rows="2" placeholder="Write a quick reply..."></textarea>
                      <div style="margin-top:6px; display:flex; gap:6px; justify-content:flex-end;">
                        <button type="button" class="btn inline-reply-cancel"
                                data-thread="{{ thread.id }}"
                                style="padding:4px 8px; font-size:0.78rem;">
                          Cancel
                        </button>
                        <button type="submit" class="btn btn-primary" style="padding:4px 10px; font-size:0.78rem;">
                          Post reply
                        </button>
                      </div>
                    </form>
                  {% endif %}
                </article>
              {% endfor %}
            {% else %}
              <div class="empty">
                No threads yet. If you're a member, start the first conversation from the button above.
              </div>
            {% endif %}
          </div>
        </section>
        <!-- RIGHT: live group chat -->
        <aside class="pane pane-right">
          <div class="pane-right-header">
            Live group chat
          </div>

          <div class="chat-thread"
               id="chat-body"
               data-room-name="{{ group_chat_room|default:group.chat_room_name }}"
               data-username="{{ request.user.username }}">
            <div class="chat-thread-inner">
              <div class="day-label-wrap">
                <span class="day-label">Today</span>
              </div>

              {% for msg in chat_messages %}
                <div class="message-row {% if msg.sender_id == request.user.id %}me{% else %}them{% endif %}">
                  <div class="message-bubble {% if msg.sender_id == request.user.id %}me{% endif %}">
                    {{ msg.body|linebreaksbr }}
                    <div class="message-meta">
                      <span>{{ msg.created_at|time:"g:i A" }}</span>
                    </div>
                  </div>
                </div>
              {% empty %}
                <p class="chat-empty">
                  No chat messages yet. Say hi!
                </p>
              {% endfor %}
            </div>
          </div>

          <div class="chat-input-wrap">
            {% if group_is_member %}
              <form id="chat-form">
                <div class="chat-input-inner">
                  <button type="button" class="icon-btn" title="Emoji">Emoji</button>
                  <textarea id="chat-input" placeholder="Type a group message..." autocomplete="off"></textarea>
                  <button type="button" class="icon-btn" title="Attach">Attach</button>
                  <button type="submit" class="send-btn">Send</button>
                </div>
              </form>
            {% else %}
              <div style="font-size:0.8rem; color:var(--text-muted);">
                Join this group to participate in the live chat.
              </div>
            {% endif %}
          </div>
        </aside>
      </div>
    </section>
  </main>
</div>

<!-- GROUP CHAT JS (same pattern as Messages) -->
<script>
(function () {
  const chatBody = document.getElementById("chat-body");
  const chatForm = document.getElementById("chat-form");
  const chatInput = document.getElementById("chat-input");

  if (!chatBody || !chatForm || !chatInput) {
    return;
  }

  const roomName = chatBody.dataset.roomName;
  const username = chatBody.dataset.username;
  if (!roomName) {
    return;
  }
  const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
  const socketUrl = `${wsScheme}://${window.location.host}/ws/chat/${roomName}/`;

  const chatSocket = new WebSocket(socketUrl);

  function appendMessage(text, fromUser, isMeOverride) {
    const isMe = typeof isMeOverride === "boolean" ? isMeOverride : (fromUser === username);
    const inner = chatBody.querySelector(".chat-thread-inner") || chatBody;

    const row = document.createElement("div");
    row.className = "message-row " + (isMe ? "me" : "them");

    const bubble = document.createElement("div");
    bubble.className = "message-bubble" + (isMe ? " me" : "");
    bubble.textContent = text;

    const meta = document.createElement("div");
    meta.className = "message-meta";
    const timeSpan = document.createElement("span");
    const now = new Date();
    timeSpan.textContent = now.toLocaleTimeString([], { hour: "numeric", minute: "2-digit" });
    meta.appendChild(timeSpan);

    bubble.appendChild(meta);
    row.appendChild(bubble);
    inner.appendChild(row);
    chatBody.scrollTop = chatBody.scrollHeight;
  }

  chatSocket.onmessage = function (e) {
    let data;
    try {
      data = JSON.parse(e.data);
    } catch (err) {
      console.error("Could not parse WebSocket message", e.data);
      return;
    }
    const msgText = (data.message || "").trim();
    const fromUser = data.user || "";
    if (!msgText) return;
    appendMessage(msgText, fromUser);
  };

  chatSocket.onclose = function (e) {
    console.error("Group chat socket closed unexpectedly", e);
  };

  chatForm.addEventListener("submit", function (e) {
    e.preventDefault();
    const text = chatInput.value.trim();
    if (!text) return;
    chatSocket.send(JSON.stringify({ message: text }));
    chatInput.value = "";
    chatInput.focus();
  });
})();
</script>

<!-- Inline reply toggle JS (center threads) -->
<script>
  document.querySelectorAll(".inline-reply-toggle").forEach((btn) => {
    btn.addEventListener("click", () => {
      const id = btn.dataset.thread;
      const form = document.querySelector(`.inline-reply-form[data-thread="${id}"]`);
      if (form) {
        form.style.display = form.style.display === "none" || form.style.display === "" ? "block" : "none";
      }
    });
  });

  document.querySelectorAll(".inline-reply-cancel").forEach((btn) => {
    btn.addEventListener("click", () => {
      const id = btn.dataset.thread;
      const form = document.querySelector(`.inline-reply-form[data-thread="${id}"]`);
      if (form) form.style.display = "none";
      if (!form && id === "new") {
        const newForm = document.getElementById("new-thread-form");
        if (newForm) newForm.style.display = "none";
      }
    });
  });

  const toggleNewThread = document.getElementById("toggle-new-thread");
  const newThreadForm = document.getElementById("new-thread-form");
  if (toggleNewThread && newThreadForm) {
    toggleNewThread.addEventListener("click", () => {
      const isHidden = newThreadForm.style.display === "none" || !newThreadForm.style.display;
      newThreadForm.style.display = isHidden ? "block" : "none";
    });
  }
</script>

<!-- Ensure profile modal wiring works on this page -->
<script>
  (function () {
    function bindProfileModal() {
      if (window.ModalManager && window.ModalManager.setupModal) {
        window.ModalManager.setupModal(["profile-button"], "profile-modal");
      }
    }
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", bindProfileModal);
    } else {
      bindProfileModal();
    }
  })();
</script>

<!-- Profile modal JS (same as other pages) -->
{% include 'partials/profile_modal_script.html' %}

</body>
</html>

