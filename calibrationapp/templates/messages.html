{% load static %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Messages · Calibration</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    :root {
      /* --- OCEAN TEAL CALIBRATION THEME --- */
      --bg-main: #EEEEEE;
      --bg-soft: #C3E4E9;
      --card-soft: #EAF3F6;

      --accent: #056C89;
      --accent-soft: #88B4BE;
      --accent-strong: #023653;

      --text-main: #022432;
      --text-muted: #4B6770;

      --border-subtle: #C5D4D8;

      --radius-lg: 18px;
      --radius-pill: 999px;

      --shadow-soft: 0 16px 40px rgba(2, 54, 83, 0.18);

      --sidebar-w: 260px;
      --pane-h: min(78vh, 680px);
    }

    *, *::before, *::after { box-sizing: border-box; }

    html, body {
      margin: 0;
      padding: 0;
      min-height: 100%;
      background: var(--bg-main);
      color: var(--text-main);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Inter, sans-serif;
    }

    a { color: inherit; text-decoration: none; }

    /* === APP LAYOUT (match Rewards / Dashboard) === */
    .app-shell {
      display: grid;
      grid-template-columns: var(--sidebar-w) minmax(0, 1fr);
      min-height: 100vh;
    }

    @media (max-width: 900px) {
      .app-shell {
        grid-template-columns: 1fr;
      }
    }

    /* === SIDEBAR (sticky, shared style) === */
    .sidebar {
      background: linear-gradient(180deg, #023653 0%, #000000 100%);
      color: #E5E7EB;
      border-right: 1px solid #000000;
      padding: 18px 18px 20px;
      display: flex;
      flex-direction: column;
      gap: 18px;

      position: sticky;
      top: 0;
      height: 100vh;
      align-self: start;
      z-index: 40;
      box-shadow: 10px 0 30px rgba(0, 0, 0, 0.5);
    }

    @media (max-width: 900px) {
      .sidebar {
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
        position: static;
        height: auto;
        box-shadow: none;
      }
    }

    .brand {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .brand-mark {
    width: 36px;
    height: 36px;
    border-radius: 999px;
    background: linear-gradient(135deg, var(--accent), var(--accent-soft));
    display: flex;
    align-items: center;
    justify-content: center;
    color: #f9fafb;
    font-weight: 800;
    font-size: 0.9rem;
    box-shadow: 0 0 0 2px #000000;
  }

  .brand-text {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }
  .brand-title {
    font-size: 1rem;
    font-weight: 700;
    letter-spacing: 0.16em;
    text-transform: uppercase;
    color: #F9FAFB;
  }
  .brand-subtitle {
    font-size: 0.72rem;
    color: #D1E2F2;
  }

  .nav {
    display: flex;
    flex-direction: column;
    gap: 4px;
    margin-top: 6px;
  }
  .nav-link {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
    padding: 8px 10px;
    position: relative;
    border-radius: 10px;
    font-size: 0.86rem;
    color: #e5e7eb;
    background: rgba(2, 16, 32, 0.8);
    border: 1px solid transparent;
    transition: background 0.16s ease, border-color 0.16s ease,
                box-shadow 0.16s ease, transform 0.12s ease, color 0.16s ease;
  }
  .nav-link:hover {
    background: #011524;
    border-color: #056C89;
    color: #ffffff;
    box-shadow: 0 8px 18px rgba(0, 0, 0, 0.6);
    transform: translateY(-1px);
  }
  .nav-link.active {
    background: linear-gradient(120deg, var(--accent), var(--accent-strong));
    color: #ffffff;
    font-weight: 600;
    box-shadow: 0 10px 26px rgba(0, 0, 0, 0.7);
    border-color: transparent;
  }
  .nav-link.has-unread::after {
    content: "";
    position: absolute;
    top: 6px;
    right: 8px;
    width: 8px;
    height: 8px;
    border-radius: 999px;
    background: #ef4444;
    box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.18);
  }



    
    .site-main-inner {
      display: flex;
      flex-direction: column;
      gap: 24px;
      padding-bottom: 28px;
    }

    /* === MAIN AREA (stretched) === */
    .site-main {
      padding: 0 22px 28px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      background:
        radial-gradient(circle at top left, rgba(136, 180, 190, 0.22), transparent 60%),
        var(--bg-main);
    }

    @media (max-width: 900px) {
      .site-main { padding: 0 14px 22px; }
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 6px 11px;
      border-radius: var(--radius-pill);
      border: 1px solid var(--border-subtle);
      background: #FFFFFF;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      color: var(--text-main);
      transition:
        background 0.12s,
        border-color 0.12s,
        box-shadow 0.12s,
        transform 0.1s;
    }

    .btn:hover {
      background: #F5FAFB;
      border-color: #B4C7CD;
      box-shadow: 0 10px 22px rgba(2, 54, 83, 0.18);
      transform: translateY(-1px);
    }

    .btn-primary {
      border-color: transparent;
      background: var(--accent);
      color: #F2FBFF;
      box-shadow: 0 10px 26px rgba(5, 108, 137, 0.4);
    }


       .site-header {
      margin: 0 -22px 18px;
      padding: 14px 24px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      border-bottom: 1px solid var(--border-subtle);
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      position: sticky;
      top: 0;
      z-index: 10;
      box-shadow: 0 6px 16px rgba(2, 54, 83, 0.08);
    }

    @media (max-width: 900px) {
      .site-header {
        margin: 0 -14px 16px;
        padding: 12px 18px 10px;
      }
    }

     
    .site-header-title {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .site-header-title h1 {
      margin: 0;
      font-size: 1.18rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--accent-strong);
    }

    .site-header-title span {
      font-size: 0.86rem;
      color: var(--text-muted);
    }

    .header-actions {
      display: inline-flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }

    .toolbar {
      display: flex;
      align-items: center;
      gap: 10px;
    }

.profile-button {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 7px 12px;
      border-radius: 999px;
      background: #FFFFFF;
      border: 1px solid var(--border-subtle);
      box-shadow: 0 6px 16px rgba(2, 54, 83, 0.08);
      transition:
        background 0.16s ease,
        box-shadow 0.16s ease,
        transform 0.12s ease,
        border-color 0.12s ease;
    }

    .profile-button:hover {
      background: var(--card-soft);
      border-color: var(--accent-soft);
      box-shadow: 0 10px 22px rgba(2, 54, 83, 0.16);
      transform: translateY(-1px);
    }

    .avatar-wrap {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      overflow: hidden;
      background: #D1D5DB;
      flex-shrink: 0;
    }

    .avatar-wrap img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .gear-icon {
      font-size: 18px;
      color: var(--accent);
    }


    /* MODALS */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.38);
      display: none;
      z-index: 2000;
      align-items: center;
      justify-content: center;
      padding: 16px;
      backdrop-filter: blur(6px);
    }

    .modal-overlay.is-open {
      display: flex;
    }

    .modal {
      width: 380px;
      max-width: 100%;
      background: #FFFFFF;
      border-radius: 18px;
      box-shadow: 0 20px 44px rgba(0, 0, 0, 0.35);
      border: 1px solid #D3DFE8;
      overflow: hidden;
      animation: fadeInUp 0.22s ease-out forwards;
      color: var(--text-main);
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(10px) scale(0.98); }
      to   { opacity: 1; transform: translateY(0) scale(1); }
    }

    .modal-header {
      padding: 12px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(120deg, var(--accent), var(--accent-strong));
      color: #FFFFFF;
    }

    .modal-header h3 {
      margin: 0;
      font-size: 0.96rem;
    }

    .modal-close {
      font-size: 1.4rem;
      line-height: 1;
      background: transparent;
      color: #E5E7EB;
      border: none;
      cursor: pointer;
    }

    .modal-body {
      padding: 12px 16px 16px;
      font-size: 0.9rem;
      background: #F5FAFC;
    }

    .profile-modal-layout {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .profile-card {
      border-radius: 14px;
      border: 1px solid #D3DFE8;
      background: #FFFFFF;
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.12);
      overflow: hidden;
    }

    .profile-card-header {
      position: relative;
      padding: 24px 18px 40px;
      text-align: center;
      color: var(--text-main);
      background: linear-gradient(
        135deg,
        var(--card-soft) 0%,
        #FFFFFF 60%
      );
    }

    .profile-card-header p {
      margin: 0;
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    .profile-card-header h4 {
      margin: 6px 0 0;
      font-size: 1.05rem;
      color: var(--accent-strong);
    }

    .profile-tagline {
      margin-top: 3px;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .profile-avatar-shell {
      position: absolute;
      left: 50%;
      bottom: -28px;
      transform: translateX(-50%);
      width: 70px;
      height: 70px;
      border-radius: 999px;
      border: 3px solid #FFFFFF;
      overflow: hidden;
      background: #D1D5DB;
      box-shadow: 0 10px 24px rgba(0, 0, 0, 0.3);
    }

    .profile-avatar-shell img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .profile-card-main {
      padding: 40px 16px 14px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      background: #FFFFFF;
    }

    .profile-detail-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
      font-size: 0.8rem;
    }

    .profile-detail-item {
      background: #F5FAFC;
      border-radius: 10px;
      padding: 6px 8px;
      border: 1px solid #D3DFE8;
    }

    .profile-detail-label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      margin-bottom: 1px;
    }

    .profile-detail-value {
      font-size: 0.86rem;
      color: var(--text-main);
    }

    .profile-quick-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 4px;
    }

    .p-btn {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #D3DFE8;
      background: #FFFFFF;
      font-size: 0.8rem;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: var(--text-main);
      transition:
        background 0.14s ease,
        border-color 0.14s ease,
        box-shadow 0.14s ease,
        transform 0.14s ease;
    }

    .p-btn-primary {
      background: linear-gradient(120deg, var(--accent), var(--accent-strong));
      color: #FFFFFF;
      border-color: transparent;
      box-shadow: 0 8px 18px rgba(2, 54, 83, 0.5);
    }

    .p-btn-primary:hover {
      filter: brightness(1.05);
      transform: translateY(-1px);
    }

    .p-btn-ghost {
      background: #F5FAFC;
    }

    .p-btn-ghost:hover {
      background: var(--card-soft);
    }

    .p-btn-logout {
      background: #FEE2E2;
      border-color: #FECACA;
      color: #B91C1C;
    }

    .p-btn-logout:hover {
      background: #FECACA;
    }

    .profile-quick-links {
      border-radius: 14px;
      border: 1px solid #D3DFE8;
      background: #FFFFFF;
      padding: 10px 12px;
      font-size: 0.8rem;
      color: var(--text-main);
      box-shadow: 0 10px 22px rgba(0, 0, 0, 0.08);
    }

    .profile-quick-links h4 {
      margin: 0 0 4px;
      font-size: 0.84rem;
      color: var(--accent-strong);
    }

    .profile-quick-links ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .profile-quick-links li + li {
      margin-top: 3px;
    }

    .profile-quick-links a {
      color: var(--accent);
    }

    .profile-quick-links a:hover {
      color: var(--accent-strong);
      text-decoration: underline;
    }

    .profile-footnote {
      font-size: 0.78rem;
      color: var(--text-muted);
      margin-top: 6px;
    }

    /* === MESSAGES SHELL === */
    .messages-shell {
      border-radius: var(--radius-lg);
      padding: 14px;
      background:
        radial-gradient(circle at top left, rgba(136, 180, 190, 0.2), transparent 55%),
        radial-gradient(circle at bottom right, rgba(2, 54, 83, 0.12), transparent 55%),
        rgba(250, 252, 255, 0.96);
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(2, 54, 83, 0.18);
    }

    .messages-main {
      display: grid;
      grid-template-columns: 260px minmax(0, 1.8fr) 260px;
      min-height: var(--pane-h);
      gap: 10px;
    }

    @media (max-width: 1100px) {
      .messages-main {
        grid-template-columns: 240px minmax(0, 1.6fr);
        grid-template-areas:
          "list chat"
          "list details";
      }
      .pane-list { grid-area: list; }
      .pane-chat { grid-area: chat; }
      .pane-details { grid-area: details; }
    }

    @media (max-width: 800px) {
      .messages-main {
        grid-template-columns: minmax(0, 1fr);
        grid-template-areas:
          "chat"
          "list"
          "details";
      }
    }

    @media (max-width: 640px) {
      .messages-shell { padding: 10px; }
    }

    .pane {
      display: flex;
      flex-direction: column;
      min-height: 0;
      border-radius: 16px;
      background: rgba(255, 255, 255, 0.96);
      border: 1px solid rgba(197, 212, 216, 0.9);
      backdrop-filter: blur(10px);
      overflow: hidden;
    }

    .pane-list {
      background: linear-gradient(180deg, var(--card-soft) 0%, #F7FCFE 100%);
    }

    .pane-chat {
      background: radial-gradient(circle at top, var(--bg-soft) 0, #FFFFFF 55%, #F7FCFE 100%);
      animation: fadeInPane 0.25s ease-out;
    }

    .pane-details {
      background: linear-gradient(180deg, var(--card-soft) 0%, #E5F6F8 100%);
    }

    @keyframes fadeInPane {
      from { opacity: 0; transform: translateY(4px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    /* === LEFT PANE – CONVERSATION LIST === */
    .pane-list-header {
      padding: 10px 14px;
      border-bottom: 1px solid var(--border-subtle);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .pane-list-header-title {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.82rem;
      font-weight: 600;
    }

    .pane-list-header small {
      font-size: 0.72rem;
      color: var(--text-muted);
    }

    .pane-search {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 5px 9px;
      border-radius: var(--radius-pill);
      border: 1px solid var(--border-subtle);
      background: #FFFFFF;
      font-size: 0.78rem;
      color: var(--text-muted);
      box-shadow: 0 6px 14px rgba(2, 54, 83, 0.12);
    }

    .pane-search input {
      border: none;
      background: transparent;
      outline: none;
      font-size: 0.78rem;
      flex: 1;
    }

    .conversation-list {
      list-style: none;
      margin: 0;
      padding: 6px 6px 8px;
      flex: 1;
      overflow-y: auto;
    }

    .conversation-item {
      display: grid;
      grid-template-columns: auto 1fr auto;
      gap: 8px;
      padding: 7px 8px;
      margin-bottom: 4px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 0.8rem;
      align-items: center;
      background: rgba(248, 252, 255, 0.9);
      transition:
        background 0.12s,
        transform 0.1s,
        box-shadow 0.12s;
    }

    .conversation-item:hover {
      background: rgba(136, 180, 190, 0.16);
      box-shadow: 0 8px 18px rgba(2, 54, 83, 0.22);
      transform: translateY(-1px);
    }

    .conversation-item.active {
      background: rgba(5, 108, 137, 0.16);
      box-shadow: 0 10px 24px rgba(5, 108, 137, 0.28);
    }

    .conv-avatar {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      background: rgba(5, 108, 137, 0.12);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.78rem;
      font-weight: 600;
      color: var(--accent-strong);
      flex-shrink: 0;
    }

    .conv-main {
      display: flex;
      flex-direction: column;
      gap: 1px;
      min-width: 0;
    }

    .conv-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 4px;
    }

    .conv-name {
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .conv-time {
      font-size: 0.7rem;
      color: #8CA1AA;
      flex-shrink: 0;
    }

    .conv-preview {
      font-size: 0.76rem;
      color: var(--text-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .conv-badge {
      font-size: 0.68rem;
      padding: 2px 7px;
      border-radius: 999px;
      background: #E1F8E6;
      color: #166534;
      flex-shrink: 0;
    }

    /* === MIDDLE PANE – CHAT === */
    .pane-chat-header {
      padding: 10px 16px;
      border-bottom: 1px solid var(--border-subtle);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      background: rgba(255, 255, 255, 0.96);
      backdrop-filter: blur(10px);
    }

    .chat-user {
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 0;
    }

    .chat-avatar {
      width: 34px;
      height: 34px;
      border-radius: 999px;
      background: linear-gradient(135deg, #27B0C7, #58D58F);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.82rem;
      font-weight: 600;
      color: #F9FAFB;
      flex-shrink: 0;
    }

    .chat-user-text {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }

    .chat-user-name {
      font-size: 0.9rem;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .chat-user-sub {
      font-size: 0.72rem;
      color: var(--text-muted);
    }

    .chat-meta {
      font-size: 0.72rem;
      color: var(--text-muted);
      text-align: right;
    }

    .chat-thread {
      flex: 1;
      padding: 10px 16px 12px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 4px;
      position: relative;
    }

    .chat-thread::before {
      content: "";
      position: absolute;
      inset: 0;
      background-image:
        linear-gradient(120deg, rgba(136, 180, 190, 0.08) 1px, transparent 0),
        linear-gradient(210deg, rgba(136, 180, 190, 0.05) 1px, transparent 0);
      background-size: 26px 26px;
      opacity: 0.35;
      pointer-events: none;
    }

    .chat-thread-inner {
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .day-label-wrap {
      text-align: center;
      margin-bottom: 6px;
    }

    .day-label {
      display: inline-block;
      padding: 2px 9px;
      border-radius: 999px;
      background: rgba(2, 54, 83, 0.05);
      font-size: 0.7rem;
      color: #8CA1AA;
      backdrop-filter: blur(4px);
    }

    .message-row {
      display: flex;
      margin-bottom: 2px;
    }

    .message-row.me { justify-content: flex-end; }
    .message-row.them { justify-content: flex-start; }

    .message-bubble {
      max-width: 72%;
      border-radius: 16px;
      padding: 7px 10px 4px;
      font-size: 0.82rem;
      line-height: 1.4;
      background: rgba(248, 252, 255, 0.98);
      color: #111827;
      box-shadow: 0 5px 14px rgba(2, 54, 83, 0.25);
      position: relative;
      animation: bubbleIn 0.18s ease-out;
    }

    .message-bubble.me {
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
      color: #F9FAFB;
    }

    @keyframes bubbleIn {
      from { opacity: 0; transform: translateY(4px) scale(0.98); }
      to   { opacity: 1; transform: translateY(0) scale(1); }
    }

    .message-meta {
      display: flex;
      justify-content: flex-end;
      font-size: 0.7rem;
      opacity: 0.9;
      margin-top: 2px;
    }

    .chat-empty {
      font-size: 0.8rem;
      color: #6B7280;
      margin: 4px 0 0;
    }

    .chat-input-wrap {
      border-top: 1px solid var(--border-subtle);
      padding: 9px 12px;
      background: rgba(246, 250, 252, 0.96);
      backdrop-filter: blur(8px);
    }

    .chat-input-inner {
      display: flex;
      align-items: center;
      gap: 6px;
      border-radius: var(--radius-pill);
      border: 1px solid var(--border-subtle);
      background: #FFFFFF;
      padding: 4px 8px;
      box-shadow: 0 6px 16px rgba(2, 54, 83, 0.22);
    }

    .chat-input-inner textarea {
      flex: 1;
      border: none;
      background: transparent;
      outline: none;
      resize: none;
      padding: 6px 4px;
      font-size: 0.84rem;
      height: 38px;
      max-height: 90px;
      overflow-y: auto;
    }

    .icon-btn {
      border: none;
      background: none;
      cursor: pointer;
      font-size: 0.9rem;
      padding: 4px;
      opacity: 0.8;
      transition: opacity 0.12s;
    }

    .icon-btn:hover { opacity: 1; }

    .send-btn {
      border: none;
      border-radius: var(--radius-pill);
      padding: 6px 13px;
      background: var(--accent);
      color: #F2FBFF;
      font-size: 0.78rem;
      font-weight: 600;
      cursor: pointer;
      flex-shrink: 0;
      box-shadow: 0 8px 20px rgba(5, 108, 137, 0.45);
      transition: transform 0.1s, box-shadow 0.1s;
    }

    .send-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 24px rgba(5, 108, 137, 0.55);
    }

    /* === RIGHT PANE – DETAILS + BUDDIES === */
    .pane-details-header {
      padding: 10px 16px;
      border-bottom: 1px solid var(--border-subtle);
      font-size: 0.82rem;
      font-weight: 600;
      background: rgba(248, 252, 255, 0.96);
    }

    .detail-block {
      padding: 10px 16px;
      border-bottom: 1px solid var(--border-subtle);
      font-size: 0.8rem;
    }

    .detail-label {
      font-size: 0.72rem;
      color: var(--text-muted);
      margin-bottom: 3px;
    }

    .buddies-list {
      list-style: none;
      margin: 0;
      padding: 10px 12px 10px 16px;
      flex: 1;
      overflow-y: auto;
    }

    .buddy-item {
      display: grid;
      grid-template-columns: auto 1fr auto;
      gap: 8px;
      padding: 6px 6px 6px 0;
      font-size: 0.8rem;
      align-items: center;
      border-radius: 10px;
      transition: background 0.12s, transform 0.1s;
    }

    .buddy-item:hover {
      background: rgba(5, 108, 137, 0.08);
      transform: translateY(-1px);
    }

    .buddy-avatar {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      background: rgba(5, 108, 137, 0.12);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.76rem;
      font-weight: 600;
      color: var(--accent-strong);
    }

    .buddy-main {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }

    .buddy-name {
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .buddy-note {
      font-size: 0.72rem;
      color: var(--text-muted);
    }

    .buddy-actions {
      display: flex;
      flex-direction: column;
      gap: 4px;
      align-items: flex-end;
    }

    .buddy-btn {
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: #FFFFFF;
      font-size: 0.72rem;
      cursor: pointer;
      text-decoration: none;
      white-space: nowrap;
    }

    .status-dot {
      font-size: 0.7rem;
      color: #10B981;
    }
  </style>
</head>
<body>

<div class="app-shell">
  <!-- SIDEBAR -->
  <nav class="sidebar">
    <div class="brand">
      <div class="brand-mark">CB</div>
      <div class="brand-text">
        <div class="brand-title">Calibration</div>
        <div class="brand-subtitle">Discipline · Habits · Skills</div>
      </div>
    </div>

    <div class="nav">
      <a href="{% url 'dashboard' %}" class="nav-link">Dashboard</a>
      <a href="{% url 'disciplinebuilder' %}" class="nav-link">Discipline Builder</a>
      <a href="{% url 'progresstracker' %}" class="nav-link">Progress Tracker</a>
      <a href="{% url 'rewards' %}" class="nav-link">Rewards</a>
      <a href="{% url 'messages' %}" class="nav-link active{% if has_unread_messages %} has-unread{% endif %}">Messages</a>
      <a href="{% url 'user_profile' %}" class="nav-link">Profile</a>
      <a href="{% url 'community' %}" class="nav-link">Community</a>
      <a href="{% url 'groups' %}" class="nav-link">Groups</a>
      <a href="{% url 'buddies' %}" class="nav-link">Buddies</a>
    </div>
  </nav>

  <!-- MAIN -->
  <main class="site-main">
    <!-- HEADER -->
    <header class="site-header">
      <div class="site-header-title">
        <h1>MESSAGES</h1>
        <span>Inbox-style messaging to keep your discipline on track.</span>
      </div>
      <div class="header-actions">
        <div class="toolbar">
         <button class="profile-button" id="profile-button">
            <span class="avatar-wrap">
              <img src="https://via.placeholder.com/40x40.png" alt="User avatar">
            </span>
            <span class="gear-icon">⚙️</span>
        </button> 
        <a class="btn" href="{% url 'buddies' %}">Find buddies</a>
       
        <a class="btn btn-primary" href="/accounts/logout/">Log out</a>
      </div>
      </div>
    </header>


  <!--Profile-->

   <div class="site-main-inner">

         <div class="modal-overlay" id="profile-modal" aria-hidden="true">
        <div class="modal">
          <div class="modal-header">
            <h3>Profile & Account</h3>
            <button type="button" class="modal-close" id="modal-close">&times;</button>
          </div>

          <div class="modal-body">
            <div class="profile-modal-layout">
              <article class="profile-card">
                <div class="profile-card-header">
                  <p>Welcome back</p>
                  <h4>{{ user.username }}</h4>
                  <p class="profile-tagline">Manage your Calibration account and shortcuts.</p>
                  <div class="profile-avatar-shell">
                    <img src="https://via.placeholder.com/80"
                         alt="Avatar for {{ user.username }}">
                  </div>
                </div>
                <div class="profile-card-main">
                  <div class="profile-detail-grid">
                    <div class="profile-detail-item">
                      <div class="profile-detail-label">Account</div>
                      <div class="profile-detail-value">Calibration Basic</div>
                    </div>
                    <div class="profile-detail-item">
                      <div class="profile-detail-label">Email</div>
                      <div class="profile-detail-value">
                        {{ user.email|default:"Not set" }}
                      </div>
                    </div>
                    <div class="profile-detail-item">
                      <div class="profile-detail-label">Member since</div>
                      <div class="profile-detail-value">
                        {{ user.date_joined|date:"M j, Y" }}
                      </div>
                    </div>
                    <div class="profile-detail-item">
                      <div class="profile-detail-label">Last login</div>
                      <div class="profile-detail-value">
                        {{ user.last_login|date:"M j, Y" }}
                      </div>
                    </div>
                  </div>

                  <div class="profile-quick-actions">
                    <a href="{% url 'user_profile' %}" class="p-btn p-btn-primary">View profile</a>
                    <a href="{% url 'user_settings' %}" class="p-btn p-btn-ghost">Account settings</a>
                    <a href="/accounts/logout/" class="p-btn p-btn-logout">Log out</a>
                  </div>
                </div>
              </article>

              <section class="profile-quick-links">
                <h4>Shortcuts</h4>
                <ul>
                  <li><a href="{% url 'skill_create' %}">Add a new skill</a></li>
                  <li><a href="{% url 'habit_create' %}">Create a new habit</a></li>
                  <li><a href="{% url 'rewards' %}">View your rewards</a></li>
                </ul>
                <p class="profile-footnote">
                  Use the dashboard for day-to-day tracking; this space is for account details.
                </p>
              </section>
            </div>
          </div>
        </div>
      </div>



    <!-- MESSAGES CARD -->
    <section class="messages-shell">
      <div class="messages-main">
        <!-- LEFT: conversation list -->
        <aside class="pane pane-list">
          <div class="pane-list-header">
            <div class="pane-list-header-title">
              <span>Messages</span>
              <small>All conversations</small>
            </div>
            <div class="pane-search">
              <span>🔍</span>
              <input type="text" id="conversation-search" placeholder="Search conversations">
            </div>
          </div>

          <ul class="conversation-list">
            {% if other_user %}
            <li class="conversation-item active">
              <a class="conv-avatar" href="{% url 'visitor_profile' other_user.id %}">
                {{ other_user.username|slice:":2"|upper }}
              </a>
              <div class="conv-main">
                <div class="conv-top">
                  <span class="conv-name">{{ other_user.username }}</span>
                  <span class="conv-time">Now</span>
                </div>
                <div class="conv-preview">Direct messages with this buddy.</div>
              </div>
              <span class="conv-badge">Active</span>
            </li>
            {% else %}
            <li class="conversation-item">
              <div class="conv-avatar">?</div>
              <div class="conv-main">
                <div class="conv-top">
                  <span class="conv-name">No active chat</span>
                </div>
                <div class="conv-preview">
                  Select a buddy on the right to start a conversation.
                </div>
              </div>
            </li>
            {% endif %}
          </ul>
        </aside>

        <!-- MIDDLE: chat thread -->
        <section class="pane pane-chat">
          <div class="pane-chat-header">
            <div class="chat-user">
              {% if other_user %}
              <a class="chat-avatar" href="{% url 'visitor_profile' other_user.id %}">
                {{ other_user.username|slice:":2"|upper }}
              </a>
              {% else %}
              <div class="chat-avatar">??</div>
              {% endif %}
              <div class="chat-user-text">
                <div class="chat-user-name">
                  {% if other_user %}
                    {{ other_user.username }}
                  {% else %}
                    Select someone to chat with
                  {% endif %}
                </div>
                <div class="chat-user-sub">
                  Accountability buddy · Private chat
                </div>
              </div>
            </div>
            <div class="chat-meta">
              <div>Today</div>
            </div>
          </div>

          <div class="chat-thread"
               id="chat-body"
               data-room-name="{{ room_name }}"
               data-username="{{ request.user.username }}">
            <div class="chat-thread-inner">
              <div class="day-label-wrap">
                <span class="day-label">Today</span>
              </div>

              {% for msg in chat_messages %}
                <div class="message-row {% if msg.sender_id == request.user.id %}me{% else %}them{% endif %}">
                  <div class="message-bubble {% if msg.sender_id == request.user.id %}me{% endif %}">
                    {{ msg.body|linebreaksbr }}
                    <div class="message-meta">
                      <span>{{ msg.created_at|time:"g:i A" }}</span>
                    </div>
                  </div>
                </div>
              {% empty %}
                <p class="chat-empty">
                  No messages yet. Say hi 👋
                </p>
              {% endfor %}
            </div>
          </div>

          <div class="chat-input-wrap">
            <form id="chat-form">
              <div class="chat-input-inner">
                <button type="button" class="icon-btn" title="Emoji">😊</button>
                <textarea id="chat-input" placeholder="Type a message…" autocomplete="off"></textarea>
                <button type="button" class="icon-btn" title="Attach">📎</button>
                <button type="submit" class="send-btn">Send</button>
              </div>
            </form>
          </div>
        </section>

        <!-- RIGHT: details + buddies -->
        <aside class="pane pane-details">
          <div class="pane-details-header">Details</div>

          <div class="detail-block">
            <div class="detail-label">Active chat</div>
            {% if other_user %}
              <div>{{ other_user.username }}</div>
              <div class="detail-label" style="margin-top:6px;">Relationship</div>
              <div>Accountability buddy</div>
            {% else %}
              <div>No active conversation selected.</div>
            {% endif %}
          </div>

          <div class="detail-block">
            <div class="detail-label">Notes</div>
            <div>Check in regularly, share progress, and keep each other accountable.</div>
          </div>

          <div class="pane-details-header" style="border-top:none;">Buddies</div>

          <ul class="buddies-list">
            {% for buddy in buddies %}
            <li class="buddy-item">
              <a class="buddy-avatar" href="{% url 'visitor_profile' buddy.user.id %}">
                {{ buddy.user.username|slice:":2"|upper }}
              </a>
              <div class="buddy-main">
                <div class="buddy-name">{{ buddy.user.username }}</div>
                <div class="buddy-note">Chat & accountability</div>
              </div>
              <div class="buddy-actions">
                <span class="status-dot">● Online</span>
                <a class="buddy-btn" href="{% url 'messages' %}?with={{ buddy.user.id }}">Open chat</a>
              </div>
            </li>
            {% empty %}
            <li class="buddy-item">
              <div class="buddy-main">
                <div class="buddy-name">No buddies yet</div>
                <div class="buddy-note">Find someone to share progress with.</div>
              </div>
              <div class="buddy-actions">
                <a href="{% url 'buddies' %}" class="buddy-btn">Find buddies</a>
              </div>
            </li>
            {% endfor %}
          </ul>
        </aside>
      </div>
    </section>
  </div>
  </main>
</div>

<script>
(function () {
  const chatBody = document.getElementById("chat-body");
  const chatForm = document.getElementById("chat-form");
  const chatInput = document.getElementById("chat-input");
  const conversationSearch = document.getElementById("conversation-search");
  const conversationList = document.querySelector(".conversation-list");

  if (!chatBody || !chatForm || !chatInput) {
    console.warn("Chat DOM not found.");
    return;
  }

  const roomName = chatBody.dataset.roomName;
  const username = chatBody.dataset.username;
  const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
  const socketUrl = `${wsScheme}://${window.location.host}/ws/chat/${roomName}/`;

  const chatSocket = new WebSocket(socketUrl);

  function appendMessage(text, fromUser, isMeOverride) {
    const isMe = typeof isMeOverride === "boolean" ? isMeOverride : (fromUser === username);

    const inner = chatBody.querySelector(".chat-thread-inner") || chatBody;

    const row = document.createElement("div");
    row.className = "message-row " + (isMe ? "me" : "them");

    const bubble = document.createElement("div");
    bubble.className = "message-bubble" + (isMe ? " me" : "");
    bubble.textContent = text;

    const meta = document.createElement("div");
    meta.className = "message-meta";
    const timeSpan = document.createElement("span");
    const now = new Date();
    timeSpan.textContent = now.toLocaleTimeString([], { hour: "numeric", minute: "2-digit" });
    meta.appendChild(timeSpan);

    bubble.appendChild(meta);
    row.appendChild(bubble);
    inner.appendChild(row);
    chatBody.scrollTop = chatBody.scrollHeight;
  }

  chatSocket.onmessage = function (e) {
    let data;
    try {
      data = JSON.parse(e.data);
    } catch (err) {
      console.error("Could not parse WebSocket message", e.data);
      return;
    }

    const msgText = (data.message || "").trim();
    const fromUser = data.user || "";
    if (!msgText) return;

    appendMessage(msgText, fromUser);
  };

  chatSocket.onclose = function (e) {
    console.error("Chat socket closed unexpectedly", e);
  };

  chatForm.addEventListener("submit", function (e) {
    e.preventDefault();
    const text = chatInput.value.trim();
    if (!text) return;

    chatSocket.send(JSON.stringify({ message: text }));
    chatInput.value = "";
    chatInput.focus();
  });

  // Conversation search
  if (conversationSearch && conversationList) {
    conversationSearch.addEventListener("input", function () {
      const term = (conversationSearch.value || "").toLowerCase();
      const items = Array.from(conversationList.querySelectorAll(".conversation-item"));
      items.forEach((item) => {
        const text = (item.textContent || "").toLowerCase();
        item.style.display = term && !text.includes(term) ? "none" : "";
      });
      const anyVisible = items.some((el) => el.style.display !== "none");
      conversationList.style.opacity = anyVisible ? "1" : "0.7";
    });
  }
})();
</script>


<script>
  document.addEventListener("DOMContentLoaded", function () {
    const profilePill = document.getElementById("profile-button");
    const modal = document.getElementById("profile-modal");
    const closeBtn = document.getElementById("modal-close");

    if (!profilePill || !modal || !closeBtn) return;

    function openModal() {
      modal.classList.add("is-open");
      modal.setAttribute("aria-hidden", "false");
    }

    function closeModal() {
      modal.classList.remove("is-open");
      modal.setAttribute("aria-hidden", "true");
    }

    profilePill.addEventListener("click", openModal);
    closeBtn.addEventListener("click", closeModal);

    modal.addEventListener("click", function (e) {
      if (e.target === modal) closeModal();
    });

    document.addEventListener("keydown", function (e) {
      if (e.key === "Escape" && modal.classList.contains("is-open")) {
        closeModal();
      }
    });
  });
</script>


</body>
</html>
