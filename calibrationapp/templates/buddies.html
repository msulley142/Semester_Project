<!--The html template was heavily edited using AI Generated Code -->
{% load static %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Buddies - Calibration</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="{% static 'css/base.css' %}">
  <style>
        :root {
      /* --- CALIBRATION THEME --- */
      --bg: #EEEEEE;
      --bg-soft: #C3E4E9;

      --card: #FFFFFF;
      --card-soft: #EAF3F6;

      --accent: #056C89;
      --accent-soft: #88B4BE;
      --accent-strong: #023653;

      --text-main: #022432;
      --text-muted: #4B6770;

      --border-subtle: #C5D4D8;

      --radius-lg: 18px;
      --radius-md: 12px;
      --radius-pill: 999px;

      --shadow-soft: 0 16px 40px rgba(2, 54, 83, 0.18);

      --sidebar-w: 260px;
    }
    *, *::before, *::after { box-sizing: border-box; }
    html, body { margin:0; padding:0; min-height:100%; font-family: system-ui, -apple-system, "Segoe UI", Roboto, Inter, sans-serif; color: var(--text-main); background: var(--bg); }
    a { color: inherit; text-decoration: none; }
    button { border:0; background:none; cursor:pointer; }
    /* APP SHELL */
    .app-shell { display:grid; grid-template-columns: var(--sidebar-w) minmax(0,1fr); min-height:100vh; }
    @media(max-width:900px){ .app-shell{grid-template-columns:1fr;} }
    .sidebar { background: linear-gradient(180deg, #023653 0%, #000000 100%); color:#E5E7EB; border-right:1px solid #000000; padding:18px; display:flex; flex-direction:column; gap:18px; position:sticky; top:0; height:100vh; align-self:start; z-index:40; box-shadow:10px 0 30px rgba(0,0,0,0.5); }
    @media(max-width:900px){ .sidebar{position:static;height:auto;flex-direction:row;align-items:center;justify-content:space-between;box-shadow:none;} }
    .brand{display:flex;align-items:center;gap:10px;}
    .brand-mark{width:36px;height:36px;border-radius:999px;background:linear-gradient(135deg,var(--accent),var(--accent-strong));display:flex;align-items:center;justify-content:center;color:#f9fafb;font-weight:800;font-size:0.9rem;box-shadow:0 0 0 2px #000;}
    .brand-text{display:flex;flex-direction:column;gap:2px;}
    .brand-title{font-size:1rem;font-weight:700;letter-spacing:0.16em;text-transform:uppercase;color:#F9FAFB;}
    .brand-subtitle{font-size:0.72rem;color:#D1E2F2;}
    .site-main{padding:0;display:flex;flex-direction:column;gap:16px;background:radial-gradient(circle at top left, rgba(136,180,190,0.22), transparent 60%), var(--bg);} 
    .site-main-inner{padding:0 22px 28px;display:flex;flex-direction:column;gap:24px;}
    @media(max-width:900px){.site-main-inner{padding:0 14px 22px;}}
    .site-header{margin:0 0 18px;padding:14px 24px 12px;display:flex;align-items:center;justify-content:space-between;gap:12px;border-bottom:1px solid var(--border-subtle);background:rgba(255,255,255,0.9);backdrop-filter:blur(10px);position:sticky;top:0;z-index:10;box-shadow:0 6px 16px rgba(2,54,83,0.08);width:100%;}
    @media(max-width:640px){.site-header{flex-wrap:wrap;padding:12px 16px 10px;margin-bottom:16px;}}
    .site-header-title{display:flex;flex-direction:column;gap:4px;}
    .site-header-title h1{margin:0;font-size:1.18rem;letter-spacing:0.12em;text-transform:uppercase;color:#023653;}
    .site-header-title span{font-size:0.86rem;color:var(--text-muted);}
    .header-actions{display:inline-flex;gap:8px;flex-wrap:wrap;align-items:center;}
    .toolbar{display:flex;align-items:center;gap:10px;}
    .section-title-block h1 { margin: 0; font-size: 1.32rem; letter-spacing: 0.16em; text-transform: uppercase; }
    .section-title-block p { margin: 0; font-size: 0.86rem; color: var(--text-muted); }
    .content-grid {
      display: grid;
      grid-template-columns: minmax(0, 2.1fr) minmax(0, 1.6fr);
      gap: 18px;
      align-items: flex-start;
    }
    @media (max-width: 960px) {
      .content-grid { grid-template-columns: minmax(0, 1fr); }
    }

    /* restore box styling for cards */
    .panel-card {
      background: var(--card);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-subtle);
      box-shadow: var(--shadow-soft);
      padding: 14px 16px 13px;
      position: relative;
      overflow: hidden;
    }
    .panel-card::before { content: ""; position: absolute; inset: 0; pointer-events: none; background: radial-gradient(circle at top right, rgba(14, 165, 233, 0.12), transparent 55%); opacity: 0.45; }
    .panel-card-inner { position: relative; z-index: 1; }
    .panel-card-header h2 { margin: 0; font-size: 0.98rem; }
    .panel-card-header span { font-size: 0.78rem; color: var(--text-muted); }
    .item-list { list-style: none; padding: 0; margin: 4px 0 0; }
    .item { display: flex; align-items: center; justify-content: space-between; gap: 10px; padding: 7px 9px; border-radius: var(--radius-md); background: var(--card-soft); border: 1px solid #e2e8f0; margin-bottom: 7px; transition: box-shadow 0.15s ease, transform 0.12s ease, border-color 0.15s ease, background 0.15s ease; }
    .item:hover { transform: translateY(-1px); box-shadow: 0 10px 22px rgba(148, 163, 184, 0.5); border-color: #bfdbfe; background: #ffffff; }
    .buddy-meta { display: flex; align-items: center; gap: 8px; min-width: 0; }
    .buddy-avatar { width: 32px; height: 32px; border-radius: 999px; background: linear-gradient(135deg, var(--accent), var(--accent-strong)); color: #eff6ff; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; font-weight: 600; box-shadow: 0 0 0 2px #E8F5F8; flex-shrink: 0; }
    .buddy-main { display: flex; flex-direction: column; gap: 2px; min-width: 0; }
    .buddy-name { font-size: 0.9rem; font-weight: 600; white-space: nowrap; text-overflow: ellipsis; overflow: hidden; }
    .buddy-tag { font-size: 0.76rem; color: var(--text-muted); }
    .buddy-actions { display: flex; align-items: center; gap: 6px; flex-wrap: wrap; justify-content: flex-end; }
    .buddy-inline-form { margin: 0; }
    .buddy-inline-form button { font-family: inherit; }
    .btn-chip { border-radius: var(--radius-pill); border: 1px solid var(--border-subtle); padding: 5px 10px; font-size: 0.76rem; background: #ffffff; color: var(--text-main); cursor: pointer; display: inline-flex; align-items: center; gap: 4px; transition: background 0.15s ease, border-color 0.15s ease, box-shadow 0.15s ease, transform 0.08s ease; }
    .btn-chip:hover { background: #f8fafc; border-color: #cbd5e1; box-shadow: 0 6px 14px rgba(15, 23, 42, 0.12); transform: translateY(-1px); }
    .btn-chip-danger { border-color: rgba(248, 113, 113, 0.7); background: #fef2f2; color: #b91c1c; }
    .btn-chip-danger:hover { background: #fee2e2; border-color: #f97373; }
    .btn-chip-success { border-color: rgba(34, 197, 94, 0.7); background: #ecfdf3; color: #15803d; }
    .btn-chip-success:hover { background: #dcfce7; }
    .btn-chip-muted { border-color: #e5e7eb; color: #4b5563; background: #f9fafb; }
    .badge-small { padding: 2px 8px; border-radius: var(--radius-pill); font-size: 0.72rem; background: var(--bg-soft); color: var(--accent-strong); white-space: nowrap; }
    .requests-stack { margin-top: 4px; }
    .requests-stack > div, .requests-stack > p { margin-bottom: 6px; }
    .request-user { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
    .request-label { font-size: 0.78rem; color: var(--text-muted); }
    .send-request-form { margin-top: 10px; display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
    .send-request-form select { border-radius: var(--radius-pill); border: 1px solid var(--border-subtle); padding: 7px 11px; font-size: 0.8rem; min-width: 220px; background: #ffffff; }
    .send-request-form button { border-radius: var(--radius-pill); border: none; padding: 7px 14px; font-size: 0.8rem; font-weight: 500; cursor: pointer; background: linear-gradient(135deg, var(--accent), var(--accent-strong)); color: #eff6ff; box-shadow: 0 10px 22px rgba(2, 54, 83, 0.45); transition: background 0.15s ease, box-shadow 0.15s ease, transform 0.08s ease; }
    .send-request-form button:hover { background: linear-gradient(135deg, #045872, var(--accent-strong)); box-shadow: 0 12px 30px rgba(2, 54, 83, 0.6); transform: translateY(-1px); }
    .empty-text { font-size: 0.8rem; color: var(--text-muted); padding: 4px 0; }
  </style>
</head>
<body>
<div class="app-shell">
  <nav class="sidebar">
    <div class="brand">
      <div class="brand-mark">CB</div>
      <div class="brand-text">
        <div class="brand-title">Calibration</div>
        <div class="brand-subtitle">Discipline . Habits . Skills</div>
      </div>
    </div>
    <div class="nav">
      <a href="{% url 'dashboard' %}" class="nav-link"><span>Dashboard</span></a>
      <a href="{% url 'disciplinebuilder' %}" class="nav-link"><span>Discipline Builder</span></a>
      <a href="{% url 'progresstracker' %}" class="nav-link"><span>Progress Tracker</span></a>
      <a href="{% url 'rewards' %}" class="nav-link"><span>Rewards</span></a>
      <a href="{% url 'messages' %}" class="nav-link{% if has_unread_messages %} has-unread{% endif %}"><span>Messages</span></a>
      <a href="{% url 'user_profile' %}" class="nav-link"><span>Profile</span></a>
      <a href="{% url 'community' %}" class="nav-link"><span>Community</span></a>
      <a href="{% url 'groups' %}" class="nav-link"><span>Groups</span></a>
      <a href="{% url 'buddies' %}" class="nav-link active"><span>Buddies</span></a>
    </div>
  </nav>

  <main class="site-main">
    <header class="site-header">
      <div class="site-header-title">
        <h1>Buddies</h1>
        <span>Manage accountability partners, requests, and blocks.</span>
      </div>
      <div class="header-actions">
        <div class="toolbar">
          <a class="btn btn-sm" href="{% url 'groups' %}">Groups</a>
          <button class="profile-button" id="profile-button">
            <span class="avatar-wrap">
              <img src="https://via.placeholder.com/40x40.png" alt="User avatar">
            </span>
            <span class="gear-icon">⚙️</span>
          </button>
          <a class="btn btn-primary" href="/accounts/logout/">Log out</a>
        </div>
      </div>
    </header>

    <div class="site-main-inner">
      <!-- PROFILE MODAL -->
      <div class="modal-overlay" id="profile-modal" aria-hidden="true">
        <div class="modal">
          <div class="modal-header">
            <h3>Profile & Account</h3>
            <button type="button" class="modal-close" id="modal-close">&times;</button>
          </div>

          <div class="modal-body">
            <div class="profile-modal-layout">
              <article class="profile-card">
                <div class="profile-card-header">
                  <p>Welcome back</p>
                  <h4>{{ user.username }}</h4>
                  <p class="profile-tagline">Manage your Calibration account and shortcuts.</p>
                  <div class="profile-avatar-shell">
                    <img src="https://via.placeholder.com/80" alt="Avatar for {{ user.username }}">
                  </div>
                </div>
                <div class="profile-card-main">
                  <div class="profile-detail-grid">
                    <div class="profile-detail-item">
                      <div class="profile-detail-label">Account</div>
                      <div class="profile-detail-value">Calibration Basic</div>
                    </div>
                    <div class="profile-detail-item">
                      <div class="profile-detail-label">Email</div>
                      <div class="profile-detail-value">
                        {{ user.email|default:"Not set" }}
                      </div>
                    </div>
                    <div class="profile-detail-item">
                      <div class="profile-detail-label">Member since</div>
                      <div class="profile-detail-value">
                        {{ user.date_joined|date:"M j, Y" }}
                      </div>
                    </div>
                    <div class="profile-detail-item">
                      <div class="profile-detail-label">Last login</div>
                      <div class="profile-detail-value">
                        {{ user.last_login|date:"M j, Y" }}
                      </div>
                    </div>
                  </div>

                  <div class="profile-quick-actions">
                    <a href="{% url 'user_profile' %}" class="p-btn p-btn-primary">View profile</a>
                    <a href="{% url 'user_settings' %}" class="p-btn p-btn-ghost">Account settings</a>
                    <a href="/accounts/logout/" class="p-btn p-btn-logout">Log out</a>
                  </div>
                </div>
              </article>

              <section class="profile-quick-links">
                <h4>Shortcuts</h4>
                <ul>
                  <li><a href="{% url 'skill_create' %}">Add a new skill</a></li>
                  <li><a href="{% url 'habit_create' %}">Create a new habit</a></li>
                  <li><a href="{% url 'rewards' %}">View your rewards</a></li>
                </ul>
                <p class="profile-footnote">
                  Use the dashboard for day-to-day tracking; this space is for account details.
                </p>
              </section>
            </div>
          </div>
        </div>
      </div>

          <div class="section-header">
            <div class="section-title-block">
              <h1>Buddies</h1>
              <p>Manage your accountability partners, friend requests, and outgoing invites.</p>
              <div class="pill-row">
                <div class="badge">
                  <span> Stay accountable together</span>
                </div>
              </div>
            </div>
            <div class="section-meta">
              <div class="meta-chip">
                {% if buddies %}{{ buddies|length }} active buddy(ies){% else %}No active buddies yet{% endif %}
              </div>
              <div class="meta-chip">
                {% with incoming_count=incoming|length outgoing_count=outgoing|length %}
                  {{ incoming_count }} incoming  {{ outgoing_count }} outgoing
                {% endwith %}
              </div>
            </div>
          </div>

          <div class="content-grid">
            <div>
              <section class="panel-card">
                <div class="panel-card-inner">
                  <div class="panel-card-header">
                    <div>
                      <h2>Your buddies</h2>
                      <p class="section-subtitle">People you?re actively connected with in Calibration.</p>
                    </div>
                    <span class="badge-small">{% if buddies %}{{ buddies|length }} total{% else %}0 buddies{% endif %}</span>
                  </div>
                  <ul class="item-list">
                    {% for b in buddies %}
                      <li class="item">
                        <div class="buddy-meta">
                          <div class="buddy-avatar">{{ b.user.username|slice:":2"|upper }}</div>
                          <div class="buddy-main">
                            <div class="buddy-name"><a href="{% url 'visitor_profile' b.user.id %}" style="color:inherit; text-decoration:none;">{{ b.user.username }}</a></div>
                            <div class="buddy-tag">Active buddy</div>
                          </div>
                        </div>
                        <div class="buddy-actions">
                          <form class="buddy-inline-form" action="{% url 'buddy-remove' b.id %}" method="post">{% csrf_token %}<button type="submit" class="btn-chip btn-chip-danger"> Remove</button></form>
                          {% if b.user.id in blocked_users %}
                            <form class="buddy-inline-form" action="{% url 'unblock-user' b.user.id %}" method="post">{% csrf_token %}<button type="submit" class="btn-chip">Unblock</button></form>
                          {% else %}
                            <form class="buddy-inline-form" action="{% url 'block-user' b.user.id %}" method="post">{% csrf_token %}<button type="submit" class="btn-chip btn-chip-danger">Block</button></form>
                          {% endif %}
                        </div>
                      </li>
                    {% empty %}
                      <li class="empty-text">No buddies yet. Send a request to start your first connection.</li>
                    {% endfor %}
                  </ul>
                </div>
              </section>

              <section class="panel-card" style="margin-top: 14px;">
                <div class="panel-card-inner">
                  <div class="panel-card-header">
                    <div>
                      <h2>Send a buddy request</h2>
                      <p class="section-subtitle">Choose a user to invite as an accountability partner.</p>
                    </div>
                  </div>
                  <form action="{% url 'buddy-send' %}" method="post" class="send-request-form">
                    {% csrf_token %}
                    {{ form.receiver }}
                    <button type="submit">Send request</button>
                  </form>
                </div>
              </section>
            </div>

            <div>
              <section class="panel-card">
                <div class="panel-card-inner">
                  <div class="panel-card-header">
                    <div>
                      <h2>Incoming requests</h2>
                      <p class="section-subtitle">Other users who want to connect with you.</p>
                    </div>
                    <span class="badge-small">{% if incoming %}{{ incoming|length }} pending{% else %}No pending{% endif %}</span>
                  </div>
                  <div class="requests-stack">
                    {% for r in incoming %}
                      <div class="item">
                        <div>
                          <div class="request-user">
                            <div class="buddy-avatar">{{ r.sender.user.username|slice:":2"|upper }}</div>
                            <div class="buddy-main">
                              <div class="buddy-name">{{ r.sender.user.username }}</div>
                              <div class="request-label">Incoming buddy request</div>
                            </div>
                          </div>
                        </div>
                        <div class="buddy-actions">
                          <form class="buddy-inline-form" action="{% url 'buddy-respond' %}" method="post">
                            {% csrf_token %}
                            <input type="hidden" name="request_id" value="{{ r.id }}">
                            <button name="action" value="accept" class="btn-chip btn-chip-success"> Accept</button>
                            <button name="action" value="decline" class="btn-chip btn-chip-muted"> Decline</button>
                          </form>
                        </div>
                      </div>
                    {% empty %}
                      <p class="empty-text">No incoming requests right now.</p>
                    {% endfor %}
                  </div>
                </div>
              </section>

              <section class="panel-card" style="margin-top: 14px;">
                <div class="panel-card-inner">
                  <div class="panel-card-header">
                    <div>
                      <h2>Outgoing requests</h2>
                      <p class="section-subtitle">Requests you've sent that are still waiting on a response.</p>
                    </div>
                    <span class="badge-small">{% if outgoing %}{{ outgoing|length }} pending{% else %}No pending{% endif %}</span>
                  </div>
                  <div class="requests-stack">
                    {% for r in outgoing %}
                      <div class="item">
                        <div>
                          <div class="request-user">
                            <div class="buddy-avatar">{{ r.receiver.user.username|slice:":2"|upper }}</div>
                            <div class="buddy-main">
                              <div class="buddy-name">{{ r.receiver.user.username }}</div>
                              <div class="request-label">Waiting for them to accept</div>
                            </div>
                          </div>
                        </div>
                        <div class="buddy-actions">
                          <form class="buddy-inline-form" action="{% url 'buddy-respond' %}" method="post">
                            {% csrf_token %}
                            <input type="hidden" name="request_id" value="{{ r.id }}">
                            <button name="action" value="cancel" class="btn-chip btn-chip-danger">? Cancel</button>
                          </form>
                        </div>
                      </div>
                    {% empty %}
                      <p class="empty-text">No outgoing requests right now.</p>
                    {% endfor %}
                  </div>
                </div>
              </section>
            </div>
          </div>
        
     
    </div>
  </main>
</div>

<!-- PROFILE MODAL JS -->
{% include 'partials/profile_modal_script.html' %}
</body>
</html>
