{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
  <title>Community · Calibration</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    :root {
      /* --- SHARED CALIBRATION THEME: OCEAN TEAL --- */
      --card: #FFFFFF;
      --card-soft: #C3E4E9;

      /* teal primary scale derived from your accent colors */
      --primary-200: #88B4BE;
      --primary-300: #56A6B8;
      --primary-500: #056C89; /* accent */
      --primary-600: #045A72;
      --primary-700: #03465A;
      --primary-800: #023653; /* accent-strong */

      --text-main: #023653;
      --text-muted: #4b6470;
      --border-subtle: #B7CED4;

      --radius-lg: 18px;
      --radius-pill: 999px;

      --shadow-soft: 0 16px 40px rgba(2, 54, 83, 0.18);

      /* aliases */
      --accent: #056C89;
      --accent-soft: #88B4BE;
      --accent-strong: #023653;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Inter, sans-serif;
      background: radial-gradient(circle at 0 0, #C3E4E9 0, #EEEEEE 45%, #EEEEEE 100%);
      color: var(--text-main);
    }

    a { color: inherit; text-decoration: none; }

    /* ========== APP SHELL (match Profile) ========== */
    .app-shell {
      display: grid;
      grid-template-columns: 260px minmax(0, 1fr);
      min-height: 100vh;
    }

    @media (max-width: 1024px) {
      .app-shell {
        grid-template-columns: 1fr;
      }
    }

    /* ========== SIDEBAR (sticky, teal) ========== */
    .sidebar {
     background: linear-gradient(180deg, #023653 0%, #000000 100%);
      color: #E4F0F3;
      border-right: 1px solid #000000;
      padding: 18px 18px 20px;
      display: flex;
      flex-direction: column;
      gap: 18px;

      position: sticky;
      top: 0;
      height: 100vh;
      align-self: start;
      z-index: 40;
      box-shadow: 10px 0 30px rgba(0, 0, 0, 0.5);
    }

  .brand {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .brand-mark {
    width: 36px;
    height: 36px;
    border-radius: 999px;
    background: linear-gradient(135deg, var(--accent), var(--accent-soft));
    display: flex;
    align-items: center;
    justify-content: center;
    color: #f9fafb;
    font-weight: 800;
    font-size: 0.9rem;
    box-shadow: 0 0 0 2px #000000;
  }

  .brand-text {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }
  .brand-title {
    font-size: 1rem;
    font-weight: 700;
    letter-spacing: 0.16em;
    text-transform: uppercase;
    color: #F9FAFB;
  }
  .brand-subtitle {
    font-size: 0.72rem;
    color: #D1E2F2;
  }

  .nav {
    display: flex;
    flex-direction: column;
    gap: 4px;
    margin-top: 6px;
  }
  .nav-link {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
    padding: 8px 10px;
    position: relative;
    border-radius: 10px;
    font-size: 0.86rem;
    color: #e5e7eb;
    background: rgba(2, 16, 32, 0.8);
    border: 1px solid transparent;
    transition: background 0.16s ease, border-color 0.16s ease,
                box-shadow 0.16s ease, transform 0.12s ease, color 0.16s ease;
  }
  .nav-link:hover {
    background: #011524;
    border-color: #056C89;
    color: #ffffff;
    box-shadow: 0 8px 18px rgba(0, 0, 0, 0.6);
    transform: translateY(-1px);
  }
  .nav-link.active {
    background: linear-gradient(120deg, var(--accent), var(--accent-strong));
    color: #ffffff;
    font-weight: 600;
    box-shadow: 0 10px 26px rgba(0, 0, 0, 0.7);
    border-color: transparent;
  }
  .nav-link.has-unread::after {
    content: "";
    position: absolute;
    top: 6px;
    right: 8px;
    width: 8px;
    height: 8px;
    border-radius: 999px;
    background: #ef4444;
    box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.18);
  }

  .site-header {
      margin: 0 0 18px;
      padding: 14px 24px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      border-bottom: 1px solid var(--border-subtle);
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      position: sticky;
      top: 0;
      z-index: 10;
      box-shadow: 0 6px 16px rgba(2, 54, 83, 0.08);
    }

    @media (max-width: 640px) {
      .site-header {
        flex-wrap: wrap;
        padding: 12px 16px 10px;
        margin-bottom: 16px;
      }
    }

    .site-header-title {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .site-header-title h1 {
      margin: 0;
      font-size: 1.18rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--accent-strong);
    }

    .site-header-title span {
      font-size: 0.86rem;
      color: var(--text-muted);
    }

    .header-actions {
      display: inline-flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }


    .toolbar {
      display: flex;
      align-items: center;
      gap: 10px;
    }



    /* ========== MAIN SHELL (stretched) ========== */
    .community-shell {
      padding: 18px 24px 40px;
      width: 100%;
    }

    @media (max-width: 1024px) {
      .community-shell {
        padding: 16px 16px 32px;
      }
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 7px 12px;
      border-radius: var(--radius-pill);
      border: 1px solid var(--border-subtle);
      background: #ffffff;
      font-size: 0.84rem;
      font-weight: 500;
      cursor: pointer;
      color: var(--text-main);
      transition:
        transform 0.12s ease,
        box-shadow 0.16s ease,
        background 0.16s ease,
        border-color 0.16s ease;
    }
    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 24px rgba(2, 54, 83, 0.18);
      background: var(--accent-soft);
      border-color: var(--primary-300);
    }
    .btn-primary {
      background: linear-gradient(115deg, var(--primary-500), var(--primary-700));
      border-color: transparent;
      color: #ffffff;
      box-shadow: 0 10px 24px rgba(3, 70, 90, 0.75);
    }
    .btn-primary:hover {
      background: linear-gradient(115deg, var(--primary-600), var(--primary-800));
      box-shadow: 0 12px 28px rgba(3, 70, 90, 0.85);
    }
    .btn-sm {
      padding: 5px 10px;
      font-size: 0.78rem;
    }

    /* ========== HERO / COMMUNITY HUB (teal) ========== */
    .hero {
      background: radial-gradient(circle at 0 0, #C3E4E9 0, #023653 55%, #012132 100%);
      color: #E9F4F7;
      padding: 18px 18px 20px;
      border-radius: var(--radius-lg);
      margin-bottom: 24px;
      position: relative;
      overflow: hidden;
      box-shadow: 0 22px 60px rgba(1, 24, 39, 0.6);
      border: 1px solid rgba(1, 38, 63, 0.9);
    }
    .hero::after {
      content: "";
      position: absolute;
      inset: 0;
      background:
        radial-gradient(circle at 15% 0, rgba(136, 180, 190, 0.4), transparent 45%),
        radial-gradient(circle at 85% 10%, rgba(5, 108, 137, 0.35), transparent 40%);
      pointer-events: none;
    }
    .hero-inner {
      position: relative;
      z-index: 1;
      display: flex;
      justify-content: space-between;
      gap: 18px;
      flex-wrap: wrap;
      align-items: flex-start;
    }
    .hero-main h1 {
      margin: 0;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      font-size: 1.12rem;
    }
    .hero-main p {
      margin: 6px 0 0;
      font-size: 0.9rem;
      max-width: 520px;
      color: #D5E4EA;
    }
    .hero-actions {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 8px;
    }
    .hero-status {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: var(--radius-pill);
      background: rgba(34, 197, 94, 0.12);
      border: 1px solid rgba(74, 222, 128, 0.7);
      font-size: 0.78rem;
      color: #bbf7d0;
    }
    .hero-status-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #22c55e;
    }
    .hero-stats {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 8px;
      margin-top: 12px;
    }
    .hero-stat {
      background: rgba(1, 33, 50, 0.85);
      border-radius: 12px;
      border: 1px solid rgba(164, 196, 206, 0.7);
      padding: 8px 10px;
      font-size: 0.8rem;
    }
    .hero-stat strong {
      display: block;
      font-size: 1rem;
      color: #E9F4F7;
    }

    @media (max-width: 640px) {
      .hero {
        padding: 16px 14px 18px;
      }
      .hero-stats {
        grid-template-columns: minmax(0, 1fr);
      }
      .hero-actions {
        align-items: flex-start;
      }
    }

    /* ========== GRID (3 columns, stretched) ========== */
    .grid {
      display: grid;
      grid-template-columns: 260px minmax(0, 2.3fr) minmax(0, 1.2fr);
      gap: 18px;
      align-items: flex-start;
    }
    @media (max-width: 1100px) {
      .grid {
        grid-template-columns: minmax(0, 1.7fr) minmax(0, 1.2fr);
        grid-template-areas:
          "center right"
          "center right";
      }
      .filters-column { display: none; }
      .filters-toggle-bar { display: flex; }
      .posts-column { grid-area: center; }
      .right-column { grid-area: right; }
    }
    @media (max-width: 768px) {
      .grid {
        grid-template-columns: 1fr;
        grid-template-areas:
          "center"
          "right";
      }
      .right-column { order: 2; }
    }

    .card {
      background: var(--card);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-subtle);
      box-shadow: var(--shadow-soft);
      padding: 14px 14px 16px;
    }

    /* ========== FILTERS ========== */
    .filters-column {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .filters-header-title {
      font-size: 0.95rem;
      font-weight: 600;
      margin: 0 0 4px;
      color: var(--accent-strong);
    }
    .filters-header-sub {
      font-size: 0.78rem;
      color: var(--text-muted);
      margin: 0;
    }
    .search-input-wrap {
      position: relative;
      margin-top: 8px;
    }
    .search-input-wrap input {
      width: 100%;
      padding: 8px 30px 8px 10px;
      border-radius: var(--radius-pill);
      border: 1px solid var(--border-subtle);
      font-size: 0.84rem;
      background: #FFFFFF;
    }
    .search-input-wrap span {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 0.8rem;
      color: #7b99a5;
    }

    .tabs-row {
      display: flex;
      gap: 6px;
      margin-top: 10px;
    }
    .tab-pill {
      flex: 1;
      padding: 6px 0;
      border-radius: var(--radius-pill);
      border: 1px solid var(--border-subtle);
      font-size: 0.78rem;
      background: #FFFFFF;
      cursor: pointer;
      text-align: center;
      transition:
        background 0.14s ease,
        border-color 0.14s ease,
        color 0.14s ease;
    }
    .tab-pill.active {
      background: var(--primary-500);
      border-color: var(--primary-500);
      color: #f9fafb;
      font-weight: 600;
    }

    .filters-section-label {
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #7b99a5;
      margin: 12px 0 4px;
    }
    .topics-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: grid;
      gap: 6px;
    }
    .topic-item {
      border-radius: var(--radius-pill);
      padding: 7px 10px;
      border: 1px solid var(--border-subtle);
      background: #FFFFFF;
      font-size: 0.84rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition:
        background 0.14s ease,
        border-color 0.14s ease,
        transform 0.12s ease,
        box-shadow 0.14s ease;
    }
    .topic-item:hover {
      background: var(--card-soft);
      border-color: var(--primary-200);
      box-shadow: 0 10px 22px rgba(2, 54, 83, 0.12);
      transform: translateY(-1px);
    }
    .topic-item.active {
      background: var(--accent-soft);
      border-color: var(--primary-500);
      color: var(--accent-strong);
      font-weight: 600;
    }
    .topic-label {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .topic-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--primary-500);
    }

    /* small-screen filters drawer */
    .filters-toggle-bar {
      display: none;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .filters-drawer {
      display: none;
      margin-bottom: 12px;
    }
    .filters-drawer.open { display: block; }

    /* ========== POSTS (CENTER, scrollable) ========== */
    .posts-column {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .posts-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 4px;
    }
    .posts-header h2 {
      margin: 0;
      font-size: 0.94rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--accent-strong);
    }
    .posts-header span {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .posts-card {
      display: flex;
      flex-direction: column;
      height: 60vh;
      max-height: 640px;
    }

    .threads-scroll {
      flex: 1;
      margin-top: 6px;
      overflow-y: auto;
      padding-right: 4px;
    }
    .threads-scroll::-webkit-scrollbar {
      width: 6px;
    }
    .threads-scroll::-webkit-scrollbar-track {
      background: #d2e1e6;
      border-radius: 999px;
    }
    .threads-scroll::-webkit-scrollbar-thumb {
      background: #7b99a5;
      border-radius: 999px;
    }

    .thread-card {
      background: var(--card-soft);
      border-radius: 16px;
      border: 1px solid var(--border-subtle);
      padding: 13px 16px 10px;
      margin-bottom: 10px;
      box-shadow: 0 14px 34px rgba(2, 54, 83, 0.14);
      transition:
        transform 0.12s ease,
        box-shadow 0.15s ease,
        border-color 0.15s ease,
        background 0.15s ease;
    }
    .thread-card:hover {
      transform: translateY(-2px);
      border-color: var(--primary-200);
      box-shadow: 0 18px 40px rgba(2, 54, 83, 0.2);
      background: #FFFFFF;
    }

    .thread-meta-row {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.78rem;
      color: var(--text-muted);
      margin-bottom: 4px;
      flex-wrap: wrap;
    }
    .meta-avatar {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      background: #E8F5F8;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--primary-700);
      flex-shrink: 0;
    }
    .meta-dot {
      width: 4px;
      height: 4px;
      border-radius: 999px;
      background: #B7CED4;
    }
    .thread-title {
      margin: 0;
      font-size: 1.02rem;
      font-weight: 700;
      color: var(--accent-strong);
    }
    .thread-preview {
      margin: 6px 0 4px;
      font-size: 0.86rem;
      color: #325261;
      line-height: 1.5;
    }

    .thread-footer {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.8rem;
      color: #486777;
      margin-top: 2px;
      flex-wrap: wrap;
    }
    .vote {
      display: inline-flex;
      align-items: center;
      gap: 3px;
      padding: 0 4px;
      border-radius: 999px;
      border: 1px solid transparent;
      background: transparent;
      cursor: pointer;
      font-size: 0.8rem;
    }
    .vote-up { color: #16a34a; }
    .vote-down { color: #dc2626; }
    .thread-footer-spacer { flex: 1; }

    .empty {
      padding: 14px;
      border-radius: 12px;
      border: 1px dashed var(--border-subtle);
      background: #FFFFFF;
      color: #486777;
      font-size: 0.88rem;
    }

    /* ========== RIGHT COLUMN (status + members + groups) ========== */
    .right-column {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .right-title {
      margin: 0 0 6px;
      font-size: 0.9rem;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--accent-strong);
    }
    .right-sub {
      margin: 0 0 10px;
      font-size: 0.8rem;
      color: var(--text-muted);
    }
    .members-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.8rem;
      margin-bottom: 10px;
      color: #486777;
    }
    .top-members-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: grid;
      gap: 6px;
    }
    .top-member {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 8px;
      border-radius: 10px;
      background: #FFFFFF;
      border: 1px solid var(--border-subtle);
      font-size: 0.84rem;
    }
    .top-member-main {
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .mini-avatar {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      background: #E8F5F8;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.72rem;
      font-weight: 600;
      color: var(--primary-700);
    }

    .groups-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: grid;
      gap: 6px;
    }
    .group-item {
      padding: 7px 10px;
      border-radius: 12px;
      border: 1px solid var(--border-subtle);
      background: #FFFFFF;
      font-size: 0.84rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition:
        background 0.12s ease,
        border-color 0.12s ease,
        box-shadow 0.14s ease,
        transform 0.12s ease;
    }
    .group-item:hover {
      background: var(--card-soft);
      border-color: var(--primary-200);
      box-shadow: 0 10px 22px rgba(2, 54, 83, 0.16);
      transform: translateY(-1px);
    }
    .group-main {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .group-name {
      font-weight: 600;
      font-size: 0.86rem;
      color: var(--accent-strong);
    }
    .group-meta {
      font-size: 0.76rem;
      color: var(--text-muted);
    }
    .group-pill {
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid #B7CED4;
      background: #FFFFFF;
      font-size: 0.75rem;
      cursor: pointer;
    }

    /* ========== MODAL ========== */
    
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.55);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 50;
    backdrop-filter: blur(6px);
  }
  .modal-overlay.is-open { display: flex; }

  .modal {
    background: #ffffff;
    border-radius: 18px;
    border: 1px solid #C3E4E9;
    box-shadow: 0 20px 60px rgba(0,0,0,0.35);
    width: 100%;
    max-width: 420px;
    padding: 14px 14px 12px;
    color: #023653;
  }

  .modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 8px;
  }

  .modal-header h3 {
    margin: 0;
    font-size: 0.98rem;
    letter-spacing: 0.08em;
    text-transform: uppercase;
  }

  .modal-close {
    border: none;
    background: transparent;
    font-size: 1.3rem;
    line-height: 1;
    cursor: pointer;
    color: #9ca3af;
  }
  .modal-close:hover { color: #000000; }

  .modal-body {
    display: flex;
    flex-direction: column;
    gap: 7px;
    margin-bottom: 10px;
    font-size: 0.78rem;
  }

  .modal-body label {
    color: var(--text-muted);
    font-size: 0.76rem;
  }

  .modal-body input,
  .modal-body textarea,
  .modal-body select {
    border-radius: 10px;
    border: 1px solid #C3E4E9;
    background: #ffffff;
    padding: 6px 8px;
    font-size: 0.78rem;
    color: #023653;
    outline: none;
  }

  .modal-body input:focus,
  .modal-body textarea:focus,
  .modal-body select:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 1px rgba(5,108,137,0.4);
    background: #ffffff;
  }

  .modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 6px;
    margin-top: 4px;
  }

  .profile-modal-layout {
    display: grid;
    grid-template-columns: minmax(0, 2fr) minmax(0, 1.3fr);
    gap: 12px;
  }
  @media (max-width: 640px) {
    .profile-modal-layout { grid-template-columns: minmax(0,1fr); }
  }

  .profile-card {
    border-radius: 16px;
    border: 1px solid #C3E4E9;
    background: #f9fafb;
    padding: 10px 12px 12px;
  }

  .profile-card-header {
    display: flex;
    flex-direction: column;
    gap: 6px;
    align-items: flex-start;
  }
  .profile-tagline {
    margin: 0;
    font-size: 0.78rem;
    color: #6b7280;
  }

  .profile-avatar-shell {
    width: 64px;
    height: 64px;
    border-radius: 999px;
    overflow: hidden;
    border: 2px solid var(--accent);
    margin-top: 6px;
  }

  .profile-avatar-shell img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .p-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 6px 10px;
    border-radius: 999px;
    font-size: 0.78rem;
    border: 1px solid #C3E4E9;
    background: #ffffff;
    text-decoration: none;
    cursor: pointer;
    transition: background 0.15s ease, box-shadow 0.15s ease, transform 0.1s ease;
  }
  .p-btn:hover {
    background: #f3f4f6;
    box-shadow: 0 6px 16px rgba(0,0,0,0.12);
    transform: translateY(-1px);
  }

  .p-btn-primary {
    border-color: transparent;
    background: var(--accent);
    color: #EEEEEE;
    box-shadow: 0 10px 25px rgba(0,0,0,0.35);
  }
  .p-btn-primary:hover { background: var(--accent-strong); }

  .p-btn-ghost { color: #4b5563; }

  .p-btn-logout {
    background: #FEF2F2;
    border-color: #fecaca;
    color: #b91c1c;
  }

  .profile-quick-links {
    border-radius: 14px;
    border: 1px dashed #C3E4E9;
    padding: 8px 10px;
    font-size: 0.78rem;
    background: #f9fafb;
  }

  .profile-quick-links h4 {
    margin: 0 0 4px;
    font-size: 0.8rem;
    font-weight: 600;
    color: #023653;
  }

  .profile-quick-links ul {
    margin: 0;
    padding-left: 18px;
    color: #6b7280;
  }

  .profile-quick-links li { margin-bottom: 2px; }

  /* DASHBOARD PROFILE STYLES (override to match Dashboard) */
    .profile-button {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 7px 12px;
      border-radius: 999px;
      background: #FFFFFF;
      border: 1px solid var(--border-subtle);
      box-shadow: 0 6px 16px rgba(2, 54, 83, 0.08);
    transition:
      background 0.16s ease,
      box-shadow 0.16s ease,
      transform 0.12s ease,
      border-color 0.12s ease;
  }

  .profile-button:hover {
    background: var(--card-soft);
    border-color: var(--accent-soft);
    box-shadow: 0 10px 22px rgba(2, 54, 83, 0.16);
    transform: translateY(-1px);
  }

  .avatar-wrap {
    width: 32px;
    height: 32px;
    border-radius: 999px;
    overflow: hidden;
    background: #D1D5DB;
    flex-shrink: 0;
  }

  .avatar-wrap img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .gear-icon {
    font-size: 18px;
    color: var(--accent);
  }

  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.38);
    display: none;
    z-index: 2000;
    align-items: center;
    justify-content: center;
    padding: 16px;
    backdrop-filter: blur(6px);
  }

  .modal-overlay.is-open {
    display: flex;
  }

  .modal {
    width: 380px;
    max-width: 100%;
    background: #FFFFFF;
    border-radius: 18px;
    box-shadow: 0 20px 44px rgba(0, 0, 0, 0.35);
    border: 1px solid #D3DFE8;
    overflow: hidden;
    animation: fadeInUp 0.22s ease-out forwards;
    color: var(--text-main);
  }

  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(10px) scale(0.98); }
    to   { opacity: 1; transform: translateY(0) scale(1); }
  }

  .modal-header {
    padding: 12px 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: linear-gradient(120deg, var(--accent), var(--accent-strong));
    color: #FFFFFF;
  }

  .modal-header h3 {
    margin: 0;
    font-size: 0.96rem;
  }

  .modal-close {
    font-size: 1.4rem;
    line-height: 1;
    background: transparent;
    color: #E5E7EB;
    border: none;
    cursor: pointer;
  }

  .modal-body {
    padding: 12px 16px 16px;
    font-size: 0.9rem;
    background: #F5FAFC;
  }

  .profile-modal-layout {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .profile-card {
    border-radius: 14px;
    border: 1px solid #D3DFE8;
    background: #FFFFFF;
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.12);
    overflow: hidden;
  }

  .profile-card-header {
    position: relative;
    padding: 24px 18px 40px;
    text-align: center;
    color: var(--text-main);
    background: linear-gradient(
      135deg,
      var(--card-soft) 0%,
      #FFFFFF 60%
    );
  }

  .profile-card-header p {
    margin: 0;
    font-size: 0.78rem;
    color: var(--text-muted);
  }

  .profile-card-header h4 {
    margin: 6px 0 0;
    font-size: 1.05rem;
    color: var(--accent-strong);
  }

  .profile-tagline {
    margin-top: 3px;
    font-size: 0.8rem;
    color: var(--text-muted);
  }

  .profile-avatar-shell {
    position: absolute;
    left: 50%;
    bottom: -28px;
    transform: translateX(-50%);
    width: 70px;
    height: 70px;
    border-radius: 999px;
    border: 3px solid #FFFFFF;
    overflow: hidden;
    background: #D1D5DB;
    box-shadow: 0 10px 24px rgba(0, 0, 0, 0.3);
  }

  .profile-avatar-shell img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .profile-card-main {
    padding: 40px 16px 14px;
    display: flex;
    flex-direction: column;
    gap: 12px;
    background: #FFFFFF;
  }

  .profile-detail-grid {
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 8px;
    font-size: 0.8rem;
  }

  .profile-detail-item {
    background: #F5FAFC;
    border-radius: 10px;
    padding: 6px 8px;
    border: 1px solid #D3DFE8;
  }

  .profile-detail-label {
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-muted);
    margin-bottom: 1px;
  }

  .profile-detail-value {
    font-size: 0.86rem;
    color: var(--text-main);
  }

  .profile-quick-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 4px;
  }

  .p-btn {
    padding: 6px 10px;
    border-radius: 999px;
    border: 1px solid #D3DFE8;
    background: #FFFFFF;
    font-size: 0.8rem;
    font-weight: 500;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    color: var(--text-main);
    transition:
      background 0.14s ease,
      border-color 0.14s ease,
      box-shadow 0.14s ease,
      transform 0.14s ease;
  }

  .p-btn-primary {
    background: linear-gradient(120deg, var(--accent), var(--accent-strong));
    color: #FFFFFF;
    border-color: transparent;
    box-shadow: 0 8px 18px rgba(2, 54, 83, 0.5);
  }

  .p-btn-primary:hover {
    filter: brightness(1.05);
    transform: translateY(-1px);
  }

  .p-btn-ghost {
    background: #F5FAFC;
  }

  .p-btn-ghost:hover {
    background: var(--card-soft);
  }

  .p-btn-logout {
    background: #FEE2E2;
    border-color: #FECACA;
    color: #B91C1C;
  }

  .p-btn-logout:hover {
    background: #FECACA;
  }

  .profile-quick-links {
    border-radius: 14px;
    border: 1px solid #D3DFE8;
    background: #FFFFFF;
    padding: 10px 12px;
    font-size: 0.8rem;
    color: var(--text-main);
    box-shadow: 0 10px 22px rgba(0, 0, 0, 0.08);
  }

  .profile-quick-links h4 {
    margin: 0 0 4px;
    font-size: 0.84rem;
    color: var(--accent-strong);
  }

  .profile-quick-links ul {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .profile-quick-links li + li {
    margin-top: 3px;
  }

  .profile-quick-links a {
    color: var(--accent);
  }

  .profile-quick-links a:hover {
    color: var(--accent-strong);
    text-decoration: underline;
  }

  .profile-footnote {
    font-size: 0.78rem;
    color: var(--text-muted);
    margin-top: 6px;
  }
  </style>
</head>
<body>

<div class="app-shell">
  <!-- SIDEBAR -->
  <nav class="sidebar" role="navigation" aria-label="Sidebar">
    <div class="brand">
      <div class="brand-mark">CB</div>
      <div class="brand-text">
        <div class="brand-title">Calibration</div>
        <div class="brand-subtitle">Discipline · Habits · Skills</div>
      </div>
    </div>

    <div class="nav">
      <a href="{% url 'dashboard' %}" class="nav-link"><span>Dashboard</span></a>
      <a href="{% url 'disciplinebuilder' %}" class="nav-link"><span>Discipline Builder</span></a>
      <a href="{% url 'progresstracker' %}" class="nav-link"><span>Progress Tracker</span></a>
      <a href="{% url 'rewards' %}" class="nav-link"><span>Rewards</span></a>
      <a href="{% url 'messages' %}" class="nav-link{% if has_unread_messages %} has-unread{% endif %}"><span>Messages</span></a>
      <a href="{% url 'user_profile' %}" class="nav-link"><span>Profile</span></a>
      <a href="{% url 'community' %}" class="nav-link active"><span>Community</span></a>
      <a href="{% url 'groups' %}" class="nav-link"><span>Groups</span></a>
      <a href="{% url 'buddies' %}" class="nav-link"><span>Buddies</span></a>
    </div>
  </nav>

  <!-- MAIN -->
  <main class="main-content" role="main">
   <header class="site-header fade-in">
      <div class="site-header-title">
        <h1>Community Hub</h1>
        <span>Connect &amp; Collaborate</span>
      </div>
         <div class="header-actions">
        <div class="toolbar">
          <button class="profile-button" id="profile-button">
            <span class="avatar-wrap">
              <img src="https://via.placeholder.com/40x40.png" alt="User avatar">
            </span>
            <span class="gear-icon">⚙️</span>
          </button>
          <a class="btn btn-primary" href="/accounts/logout/">Log out</a>
        </div>
      </div>
    </header>


  <div class="community-shell">
    
       <div class="modal-overlay" id="profile-modal" aria-hidden="true">
      <div class="modal">
        <div class="modal-header">
          <h3>Profile & Account</h3>
          <button type="button" class="modal-close" id="modal-close">&times;</button>
        </div>

        <div class="modal-body">
          <div class="profile-modal-layout">
            <article class="profile-card">
              <div class="profile-card-header">
                <p>Welcome back</p>
                <h4>{{ user.username }}</h4>
                <p class="profile-tagline">Manage your Calibration account and shortcuts.</p>
                <div class="profile-avatar-shell">
                  <img src="https://via.placeholder.com/80"
                       alt="Avatar for {{ user.username }}">
                </div>
              </div>
              <div class="profile-card-main">
                <div class="profile-detail-grid">
                  <div class="profile-detail-item">
                    <div class="profile-detail-label">Account</div>
                    <div class="profile-detail-value">Calibration Basic</div>
                  </div>
                  <div class="profile-detail-item">
                    <div class="profile-detail-label">Email</div>
                    <div class="profile-detail-value">
                      {{ user.email|default:"Not set" }}
                    </div>
                  </div>
                  <div class="profile-detail-item">
                    <div class="profile-detail-label">Member since</div>
                    <div class="profile-detail-value">
                      {{ user.date_joined|date:"M j, Y" }}
                    </div>
                  </div>
                  <div class="profile-detail-item">
                    <div class="profile-detail-label">Last login</div>
                    <div class="profile-detail-value">
                      {{ user.last_login|date:"M j, Y" }}
                    </div>
                  </div>
                </div>

                <div class="profile-quick-actions">
                  <a href="{% url 'user_profile' %}" class="p-btn p-btn-primary">View profile</a>
                  <a href="{% url 'user_settings' %}" class="p-btn p-btn-ghost">Account settings</a>
                  <a href="/accounts/logout/" class="p-btn p-btn-logout">Log out</a>
                </div>
              </div>
            </article>

            <section class="profile-quick-links">
              <h4>Shortcuts</h4>
              <ul>
                <li><a href="{% url 'skill_create' %}">Add a new skill</a></li>
                <li><a href="{% url 'habit_create' %}">Create a new habit</a></li>
                <li><a href="{% url 'rewards' %}">View your rewards</a></li>
              </ul>
              <p class="profile-footnote">
                Use the dashboard for day-to-day tracking; this space is for account details.
              </p>
            </section>
          </div>
        </div>
      </div>
    </div>



     
    <!-- HERO / COMMUNITY HUB -->
    <section class="hero">
      <div class="hero-inner">
        <div class="hero-main">
          <h1>Community Hub</h1>
          <p>Swap wins, roadblocks, and ideas with people chasing similar goals. Start a thread or jump into one.</p>
          <div class="hero-stats">
            <div class="hero-stat">
              <strong>{{ threads|length }}</strong>
              Active discussions
            </div>
            <div class="hero-stat">
              <strong>{{ topics|length }}</strong>
              Topics to explore
            </div>
            <div class="hero-stat">
              <strong>Daily</strong>
              New takes from the Calibration community
            </div>
          </div>
        </div>

        <div class="hero-actions">
          <span class="hero-status">
            <span class="hero-status-dot"></span> Online now
          </span>
          <button id="openThreadModalHeader" class="btn btn-primary">
            + Start a new topic
          </button>
        </div>
      </div>
    </section>

    <!-- Filters toggle (mobile) -->
    <div class="filters-toggle-bar">
      <span style="font-size:0.86rem; color:var(--text-muted);">Browse by topic</span>
      <button id="filtersToggleBtn" class="btn" style="padding:6px 10px; font-size:0.8rem;">
        Filters
      </button>
    </div>

    <!-- GRID -->
    <section class="grid">

      <!-- LEFT: Filters -->
      <aside class="filters-column" id="filtersColumn">
        <div class="card">
          <p class="filters-header-title">Browse discussions</p>
          <p class="filters-header-sub">Search and filter threads by topic.</p>

          <div class="search-input-wrap">
            <input type="text" placeholder="Search for topics…" autocomplete="off">
            <span>⌕</span>
          </div>

          <div class="tabs-row" id="tabsRow">
            <button class="tab-pill active" data-tab="latest">Latest</button>
            <button class="tab-pill" data-tab="popular">Popular</button>
            <button class="tab-pill" data-tab="older">Older</button>
          </div>

          <div class="filters-section-label">Topics ({{ topics|length }})</div>

          <ul class="topics-list">
            <li class="topic-item {% if not selected_topic %}active{% endif %}">
              <a href="{% url 'community' %}">
                <span class="topic-label">
                  <span class="topic-dot"></span>All topics
                </span>
              </a>
            </li>
            {% for t in topics %}
              <li class="topic-item {% if selected_topic|stringformat:'s' == t.id|stringformat:'s' %}active{% endif %}">
                <a href="{% url 'community' %}?topic={{ t.id }}">
                  <span class="topic-label">
                    <span class="topic-dot"></span>{{ t.name }}
                  </span>
                </a>
              </li>
            {% empty %}
              <li class="topic-item">
                <span class="topic-label">No topics yet</span>
              </li>
            {% endfor %}
          </ul>
        </div>

        <!-- Buddies box -->
        <div class="card" style="margin-top:12px; border-radius:14px; padding:12px;">
          <div style="display:flex; justify-content:space-between; align-items:center; gap:8px; flex-wrap:wrap;">
            <div>
              <h3 style="margin:0; font-size:0.95rem; color:var(--accent-strong);">Buddies</h3>
              <p style="margin:2px 0 6px; color:var(--text-muted); font-size:0.85rem;">Send or respond to buddy requests.</p>
            </div>
            <a class="btn btn-sm" href="{% url 'buddies' %}" style="font-size:0.78rem;">Open buddies</a>
          </div>

          <div style="display:grid; gap:8px; margin-top:6px;">
            <div style="border:1px solid var(--border-subtle); border-radius:10px; padding:8px; background:#FFFFFF;">
              <h4 style="margin:0 0 6px; font-size:0.9rem; color:var(--accent-strong);">Incoming</h4>
              {% for req in incoming %}
                <form method="post" action="{% url 'buddy-respond' %}" style="display:flex; gap:6px; align-items:center; margin-bottom:6px;">
                  {% csrf_token %}
                  <input type="hidden" name="request_id" value="{{ req.id }}">
                  <span style="flex:1;">{{ req.sender.user.username }}</span>
                  <button class="btn btn-primary btn-sm" name="action" value="accept" type="submit">Accept</button>
                  <button class="btn btn-sm" name="action" value="decline" type="submit">Decline</button>
                </form>
              {% empty %}
                <p style="margin:0; color:var(--text-muted); font-size:0.85rem;">No incoming requests.</p>
              {% endfor %}
            </div>

            <div style="border:1px solid var(--border-subtle); border-radius:10px; padding:8px; background:#FFFFFF;">
              <h4 style="margin:0 0 6px; font-size:0.9rem; color:var(--accent-strong);">Outgoing</h4>
              {% for req in outgoing %}
                <form method="post" action="{% url 'buddy-respond' %}" style="display:flex; gap:6px; align-items:center; margin-bottom:6px;">
                  {% csrf_token %}
                  <input type="hidden" name="request_id" value="{{ req.id }}">
                  <span style="flex:1;">{{ req.receiver.user.username }}</span>
                  <button class="btn btn-sm" name="action" value="cancel" type="submit">Cancel</button>
                </form>
              {% empty %}
                <p style="margin:0; color:var(--text-muted); font-size:0.85rem;">No outgoing requests.</p>
              {% endfor %}
            </div>

            <div style="border:1px solid var(--border-subtle); border-radius:10px; padding:8px; background:#FFFFFF;">
              <h4 style="margin:0 0 6px; font-size:0.9rem; color:var(--accent-strong);">Send request</h4>
              <form method="post" action="{% url 'buddy-send' %}" style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                {% csrf_token %}
                {{ buddy_form.receiver }}
                <button class="btn btn-primary btn-sm" type="submit">Send</button>
              </form>
              <div style="margin-top:8px;">
                <h5 style="margin:0 0 4px; font-size:0.85rem; color:var(--accent-strong);">Buddies</h5>
                {% if buddies %}
                  {% for b in buddies %}
                    <a href="{% url 'visitor_profile' b.user.id %}" style="display:flex; align-items:center; gap:8px; font-size:0.9rem; padding:4px 0; border-bottom:1px solid var(--border-subtle); color:inherit; text-decoration:none;">
                      <span style="width:28px; height:28px; border-radius:999px; background:rgba(5,108,137,0.14); display:inline-flex; align-items:center; justify-content:center; font-weight:600; font-size:0.78rem;">{{ b.user.username|slice:":2"|upper }}</span>
                      <span>{{ b.user.username }}</span>
                    </a>
                  {% endfor %}
                {% else %}
                  <p style="margin:0; color:var(--text-muted); font-size:0.85rem;">No buddies yet.</p>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </aside>

      <!-- Mobile filters drawer -->
      <div class="filters-drawer card" id="filtersDrawer">
        <p class="filters-header-title" style="margin-top:0;">Filters</p>
        <div class="tabs-row" id="tabsRowDrawer">
          <button class="tab-pill active" data-tab="latest">Latest</button>
          <button class="tab-pill" data-tab="popular">Popular</button>
          <button class="tab-pill" data-tab="older">Older</button>
        </div>
        <div class="filters-section-label">Topics</div>
        <div style="display:flex; gap:6px; flex-wrap:wrap;">
          <a href="{% url 'community' %}" class="btn btn-sm" style="font-size:0.75rem;">All</a>
          {% for t in topics %}
            <a href="{% url 'community' %}?topic={{ t.id }}" class="btn btn-sm" style="font-size:0.75rem;">
              {{ t.name }}
            </a>
          {% endfor %}
        </div>
      </div>

      <!-- CENTER: posts -->
      <div class="posts-column">
        <article class="card posts-card">
          <div class="posts-header">
            <h2>Latest posts</h2>
            <span>{{ threads|length }} active discussions</span>
          </div>

          <div class="threads-scroll">
            {% for thread in threads %}
              <a href="{% url 'community_thread' thread.id %}">
                <article class="thread-card">
                  <div class="thread-meta-row">
                    <div class="meta-avatar">
                      {{ thread.author.username|slice:":2"|upper }}
                    </div>
                    <span style="font-weight:600; font-size:0.8rem;">{{ thread.author.username }}</span>
                    <span class="meta-dot"></span>
                    <span>{{ thread.created_at|timesince }} ago</span>
                    <span class="meta-dot"></span>
                    <span>{{ thread.topic.name }}</span>
                    {% if thread.locked_forum %}
                      <span class="group-pill" style="background:#fee2e2;border-color:#fecaca;color:#b91c1c;">Locked</span>
                    {% endif %}
                  </div>

                  <h3 class="thread-title">{{ thread.title }}</h3>
                  <p class="thread-preview">{{ thread.body|truncatechars:220 }}</p>

                  <div class="thread-footer">
                    <form method="post" action="{% url 'forum_vote' thread.id %}" class="vote-form" data-thread="{{ thread.id }}" style="display:flex; gap:6px; align-items:center;">
                      {% csrf_token %}
                      <button type="submit" name="vote" value="up" class="vote vote-up">▲</button>
                      <span class="vote-count up-count" data-thread="{{ thread.id }}">{{ thread.up_count|default:0 }}</span>
                      <button type="submit" name="vote" value="down" class="vote vote-down">▼</button>
                      <span class="vote-count down-count" data-thread="{{ thread.id }}">{{ thread.down_count|default:0 }}</span>
                    </form>
                    <div class="thread-footer-spacer"></div>
                    <span class="comment-count" data-thread="{{ thread.id }}">💬 {{ thread.comment_count|default:0 }}</span>
                    <button type="button" class="btn btn-sm open-reply" data-thread="{{ thread.id }}" style="padding:4px 8px;">Reply</button>
                    {% if thread.author_id == request.user.id %}
                      <form method="post" action="{% url 'community_thread_delete' thread.id %}" style="display:inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-sm" style="padding:4px 8px; color:#b91c1c;">Delete</button>
                      </form>
                    {% endif %}
                  </div>

                  <form method="post" action="{% url 'community_thread' thread.id %}" class="inline-reply-form" data-thread="{{ thread.id }}" style="display:none; margin-top:8px; border-top:1px solid var(--border-subtle); padding-top:8px;">
                    {% csrf_token %}
                    <textarea name="body" rows="2" placeholder="Write a reply..." style="width:100%; border:1px solid var(--border-subtle); border-radius:8px; padding:6px 8px;"></textarea>
                    <div style="margin-top:6px; display:flex; gap:6px; justify-content:flex-end;">
                      <button type="button" class="btn btn-sm close-reply" data-thread="{{ thread.id }}">Cancel</button>
                      <button type="submit" class="btn btn-primary btn-sm">Post reply</button>
                    </div>
                  </form>
                </article>
              </a>
            {% empty %}
              <div class="empty">
                No discussions yet. Click <strong>“Start a new topic”</strong> in the banner to open the first thread.
              </div>
            {% endfor %}
          </div>
        </article>
      </div>

      <!-- RIGHT: status + members + groups -->
      <aside class="right-column">
        <div class="card">
          <h3 class="right-title">Community status</h3>
          <p class="right-sub">
            Calibration community is live. New threads and replies land here in real time.
          </p>
          <div class="members-row">
            <span>Online indicator</span>
            <span style="font-weight:600; color:#16a34a;">● Active</span>
          </div>
          <button id="openThreadModal" class="btn btn-primary" style="width:100%; justify-content:center;">
            + New Discussion
          </button>
        </div>

        <div class="card">
          <h3 class="right-title">Top members</h3>
          <p class="right-sub">Frequent posters and big helpers.</p>
          <ul class="top-members-list">
            <li class="top-member">
              <div class="top-member-main">
                <div class="mini-avatar">{{ user.username|slice:":2"|upper }}</div>
                <span>You</span>
              </div>
              <span style="font-size:0.78rem; color:var(--text-muted);">active</span>
            </li>
            <li class="top-member">
              <div class="top-member-main">
                <div class="mini-avatar">AP</div>
                <span>Accountability Partner</span>
              </div>
              <span style="font-size:0.78rem; color:var(--text-muted);">coming soon</span>
            </li>
          </ul>
        </div>

        <div class="card">
          <h3 class="right-title">Groups</h3>
          <p class="right-sub">Join or leave focus groups to meet people with similar goals.</p>
          <form method="post" action="{% url 'group_create' %}" style="display:grid; gap:6px; margin-bottom:8px;">
            {% csrf_token %}
            <input type="text" name="name" placeholder="Group name" required
                   style="padding:6px 8px; border:1px solid var(--border-subtle); border-radius:8px;">
            <input type="text" name="tagline" placeholder="Tagline (optional)"
                   style="padding:6px 8px; border:1px solid var(--border-subtle); border-radius:8px;">
            <textarea name="description" rows="2" placeholder="Description (optional)"
                      style="padding:6px 8px; border:1px solid var(--border-subtle); border-radius:8px;"></textarea>
            <button type="submit" class="btn btn-primary" style="justify-content:center;">Create & Join</button>
          </form>
          <ul class="groups-list">
            {% if groups %}
              {% for g in groups %}
                <li class="group-item" data-href="{% url 'group_detail' g.obj.id %}">
                  <div class="group-main">
                    <span class="group-name">{{ g.obj.name }}</span>
                    <span class="group-meta">{{ g.member_count }} members ? {{ g.obj.tagline|default:"" }}</span>
                  </div>
                  
{% if g.is_member %}
                    <form method="post" action="{% url 'group_leave' g.obj.id %}">
                      {% csrf_token %}
                      <button type="submit" class="group-pill" style="background:#fee2e2; border-color:#fecdd3; color:#b91c1c;">Leave</button>
                    </form>
                  {% else %}
                    <form method="post" action="{% url 'group_join' g.obj.id %}">
                      {% csrf_token %}
                      <button type="submit" class="group-pill">Join</button>
                    </form>
                  {% endif %}
                </li>
              {% endfor %}
            {% else %}
              <li class="group-item">
                <div class="group-main">
                  <span class="group-name">No groups yet</span>
                  <span class="group-meta">Ask an admin to add a focus group.</span>
                </div>
              </li>
            {% endif %}
          </ul>
        </div>
      </aside>

    </section>
  </div>
</div>

<!-- NEW DISCUSSION MODAL -->
<div id="threadModal" class="modal-overlay">
  <div class="modal">
    <div class="modal-header">
      <h3>New Discussion</h3>
      <button class="modal-close" id="closeThreadModal">&times;</button>
    </div>

    <form method="POST" action="{% url 'community' %}">
      {% csrf_token %}
      <div class="modal-body">
        <label for="topic">Topic</label>
        <select id="topic" name="topic">
          <option value="">-- Choose an existing topic --</option>
          {% for t in topics %}
            <option value="{{ t.id }}">{{ t.name }}</option>
          {% endfor %}
        </select>

        <label for="topic_name">Or create a new topic</label>
        <input id="topic_name" type="text" name="topic_name" maxlength="100"
               placeholder="e.g. Focus &amp; Timeboxing">

        <label for="title">Title</label>
        <input id="title" type="text" name="title" maxlength="255" required
               placeholder="Make it clear and specific">

        <label for="body">Body</label>
        <textarea id="body" name="body" rows="7" required
                  placeholder="Share your context, question, or idea."></textarea>
      </div>

      <div class="modal-footer">
        <button type="submit" class="btn btn-primary">Post thread</button>
      </div>
    </form>
  </div>
</div>

<script>
  // Modal open/close
  const threadModal = document.getElementById("threadModal");
  const openButtons = [
    document.getElementById("openThreadModal"),
    document.getElementById("openThreadModalHeader")
  ].filter(Boolean);
  const closeButton = document.getElementById("closeThreadModal");

  openButtons.forEach(btn =>
    btn.addEventListener("click", () => threadModal.classList.add("is-open"))
  );
  if (closeButton) {
    closeButton.addEventListener("click", () => threadModal.classList.remove("is-open"));
  }
  threadModal.addEventListener("click", (e) => {
    if (e.target === threadModal) threadModal.classList.remove("is-open");
  });

  // Tabs (visual only)
  function wireTabs(containerId) {
    const container = document.getElementById(containerId);
    if (!container) return;
    container.addEventListener("click", (e) => {
      const btn = e.target.closest(".tab-pill");
      if (!btn) return;
      container.querySelectorAll(".tab-pill").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
    });
  }
  wireTabs("tabsRow");
  wireTabs("tabsRowDrawer");

  // Filters drawer toggle
  const filtersToggleBtn = document.getElementById("filtersToggleBtn");
  const filtersDrawer    = document.getElementById("filtersDrawer");
  if (filtersToggleBtn && filtersDrawer) {
    filtersToggleBtn.addEventListener("click", () => {
      filtersDrawer.classList.toggle("open");
    });
  }

  // Inline replies
  document.querySelectorAll(".open-reply").forEach((btn) => {
    btn.addEventListener("click", () => {
      const threadId = btn.dataset.thread;
      const form = document.querySelector(`.inline-reply-form[data-thread="${threadId}"]`);
      if (form) form.style.display = form.style.display === "none" ? "block" : "none";
    });
  });
  document.querySelectorAll(".close-reply").forEach((btn) => {
    btn.addEventListener("click", () => {
      const threadId = btn.dataset.thread;
      const form = document.querySelector(`.inline-reply-form[data-thread="${threadId}"]`);
      if (form) form.style.display = "none";
    });
  });
  document.querySelectorAll(".inline-reply-form").forEach((form) => {
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const threadId = form.dataset.thread;
      const body = form.querySelector("textarea").value.trim();
      if (!body) return;
      const tokenInput = form.querySelector('input[name="csrfmiddlewaretoken"]');
      const token = tokenInput ? tokenInput.value : "";
      const res = await fetch(form.action, {
        method: "POST",
        headers: {
          "X-CSRFToken": token,
          "X-Requested-With": "XMLHttpRequest",
        },
        body: new FormData(form),
      });
      if (!res.ok) return;
      const data = await res.json().catch(() => null);
      if (data && data.ok) {
        const countEl = document.querySelector(`.comment-count[data-thread="${threadId}"]`);
        if (countEl) {
          countEl.textContent = `💬 ${data.comment_count}`;
        }
        form.reset();
        form.style.display = "none";
      }
    });
  });

  // Votes (capture clicked button value)
  document.querySelectorAll(".vote-form").forEach((form) => {
    const tokenInput = form.querySelector('input[name="csrfmiddlewaretoken"]');
    const token = tokenInput ? tokenInput.value : "";
    form.querySelectorAll('button[name="vote"]').forEach((btn) => {
      btn.addEventListener("click", async (e) => {
        e.preventDefault();
        const threadId = form.dataset.thread;
        const formData = new FormData(form);
        formData.set("vote", btn.value);
        const res = await fetch(form.action, {
          method: "POST",
          headers: {
            "X-CSRFToken": token,
            "X-Requested-With": "XMLHttpRequest",
          },
          body: formData,
        });
        if (!res.ok) return;
        const data = await res.json().catch(() => null);
        if (data && data.ok) {
          const upEl = document.querySelector(`.up-count[data-thread="${threadId}"]`);
          const downEl = document.querySelector(`.down-count[data-thread="${threadId}"]`);
          if (upEl) upEl.textContent = data.up;
          if (downEl) downEl.textContent = data.down;
        }
    });
  });

  // Make each group item clickable to its detail page unless a form/button is clicked
  document.querySelectorAll(".group-item[data-href]").forEach((item) => {
    item.style.cursor = "pointer";
    item.addEventListener("click", (e) => {
      const tag = e.target.tagName.toLowerCase();
      if (tag === "button" || tag === "form" || e.target.closest("form")) {
        return;
      }
      const href = item.getAttribute("data-href");
      if (href) {
        window.location.href = href;
      }
    });
  });
});
</script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const profilePill = document.getElementById("profile-button");
    const modal = document.getElementById("profile-modal");
    const closeBtn = document.getElementById("modal-close");

    if (!profilePill || !modal || !closeBtn) return;

    function openModal() {
      modal.classList.add("is-open");
      modal.setAttribute("aria-hidden", "false");
    }

    function closeModal() {
      modal.classList.remove("is-open");
      modal.setAttribute("aria-hidden", "true");
    }

    profilePill.addEventListener("click", openModal);
    closeBtn.addEventListener("click", closeModal);

    modal.addEventListener("click", function (e) {
      if (e.target === modal) closeModal();
    });

    document.addEventListener("keydown", function (e) {
      if (e.key === "Escape" && modal.classList.contains("is-open")) {
        closeModal();
      }
    });
  });
</script>

</body>
</html>
