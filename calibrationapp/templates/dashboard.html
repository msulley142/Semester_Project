{% load static %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Dashboard ‚Äì Calibration</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    :root {
      /* ---- OCEAN THEME (MATCHES DISCIPLINE BUILDER) ---- */
      --bg-main: #EEEEEE;        /* page background */
      --card: #FFFFFF;           /* main cards */
      --card-soft: #C3E4E9;      /* soft card / pill */
      --accent: #056C89;         /* primary accent */
      --accent-soft: #88B4BE;    /* lighter accent */
      --accent-strong: #023653;  /* deep teal (sidebar / titles) */

      --text-main: #02222E;
      --text-muted: #5B6B75;
      --text-inverse: #F4FAFF;

      --border-subtle: #D3DDE4;

      --radius-lg: 16px;
      --radius-md: 10px;
      --radius-pill: 999px;

      --shadow-soft: 0 12px 26px rgba(2, 54, 83, 0.12);
      --sidebar-w: 260px;

      /* mapped ‚Äúprimary scale‚Äù so existing classes still work */
      --primary-50:  #E8F5F8;
      --primary-100: var(--card-soft);
      --primary-200: #88B4BE;
      --primary-300: #61A6BA;
      --primary-400: var(--accent);
      --primary-500: #045872;
      --primary-600: #03435A;
      --primary-700: var(--accent-strong);
      --primary-800: #011E31;
    }

    *, *::before, *::after { box-sizing: border-box; }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Inter, sans-serif;
      color: var(--text-main);
      background: var(--bg-main);
    }

    body { margin: 0; }

    a { color: inherit; text-decoration: none; }
    button { border: 0; background: none; cursor: pointer; }
    .muted { color: var(--text-muted); font-size: 0.86rem; }

    .app-shell {
      display: block;
      min-height: 100vh;
    }

    /* ---- SIDEBAR (same vibe everywhere) ---- */
    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      bottom: 0;
      width: var(--sidebar-w);
      z-index: 40;
      padding: 18px 18px 20px;
      background: linear-gradient(
        180deg,
        var(--accent-strong) 0%,
        var(--accent) 100%
      );
      border-right: 1px solid rgba(1, 28, 46, 0.7);
      box-shadow: 10px 0 30px rgba(0, 0, 0, 0.25);
      display: flex;
      flex-direction: column;
      gap: 18px;
      color: var(--text-inverse);
    }

    @media (max-width: 900px) {
      .sidebar {
        position: static;
        width: 100%;
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        padding: 14px 16px;
      }
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .brand-mark {
      width: 36px;
      height: 36px;
      border-radius: 999px;
      background: linear-gradient(135deg, var(--accent), var(--accent-soft));
      display: flex;
      align-items: center;
      justify-content: center;
      color: #F9FAFB;
      font-weight: 800;
      font-size: 0.9rem;
      box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.25);
    }

    .brand-text {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .brand-title {
      font-size: 1rem;
      font-weight: 700;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: #F9FAFB;
    }

    .brand-subtitle {
      font-size: 0.72rem;
      color: #D1E2F2;
    }

    .nav {
      margin-top: 6px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    @media (max-width: 900px) {
      .nav {
        flex-direction: row;
        flex-wrap: wrap;
        justify-content: flex-end;
        gap: 6px;
        margin-top: 0;
      }
    }

    .nav-link {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 8px 10px;
      position: relative;
      border-radius: var(--radius-md);
      font-size: 0.86rem;
      color: #E4F0F8;
      background: rgba(0, 0, 0, 0.08);
      border: 1px solid transparent;
      transition:
        background 0.18s ease,
        border-color 0.18s ease,
        box-shadow 0.18s ease,
        transform 0.12s ease,
        color 0.16s ease;
    }

    .nav-link:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(255, 255, 255, 0.25);
      box-shadow: 0 10px 22px rgba(0, 0, 0, 0.35);
      transform: translateY(-1px);
    }

    .nav-link.active {
      background: #FFFFFF;
      color: var(--accent-strong);
      border-color: transparent;
      box-shadow: 0 10px 22px rgba(0, 0, 0, 0.4);
      font-weight: 600;
    }

    .nav-link.has-unread::after {
      content: "";
      position: absolute;
      top: 6px;
      right: 8px;
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #F97373;
      box-shadow: 0 0 0 3px rgba(249, 115, 115, 0.25);
    }

    /* ---- MAIN LAYOUT ---- */
    .site-main {
      margin-left: var(--sidebar-w);
      background: var(--bg-main);
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    @media (max-width: 900px) {
      .site-main {
        margin-left: 0;
      }
    }

    .site-main-inner {
      display: flex;
      flex-direction: column;
      gap: 24px;
      padding-bottom: 28px;
    }

    /* ---- HEADER (matches DB header styling) ---- */
    .site-header {
      margin: 0 0 18px;
      padding: 14px 24px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      border-bottom: 1px solid var(--border-subtle);
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      position: sticky;
      top: 0;
      z-index: 10;
      box-shadow: 0 6px 16px rgba(2, 54, 83, 0.08);
    }

    @media (max-width: 640px) {
      .site-header {
        flex-wrap: wrap;
        padding: 12px 16px 10px;
        margin-bottom: 16px;
      }
    }

    .site-header-title {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .site-header-title h1 {
      margin: 0;
      font-size: 1.18rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--accent-strong);
    }

    .site-header-title span {
      font-size: 0.86rem;
      color: var(--text-muted);
    }

    .header-actions {
      display: inline-flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }

    .toolbar {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 7px 12px;
      border-radius: var(--radius-pill);
      font-size: 0.8rem;
      font-weight: 500;
      border: 1px solid var(--border-subtle);
      background: #FFFFFF;
      color: var(--text-main);
      cursor: pointer;
      text-decoration: none;
      transition:
        background 0.16s ease,
        border-color 0.16s ease,
        box-shadow 0.16s ease,
        transform 0.12s ease,
        color 0.12s ease;
    }

    .btn:hover {
      background: var(--card-soft);
      border-color: var(--accent-soft);
      box-shadow: 0 8px 20px rgba(2, 54, 83, 0.16);
      transform: translateY(-1px);
    }

    .btn-primary {
      border-color: transparent;
      background: linear-gradient(115deg, var(--accent), var(--accent-strong));
      color: #FFFFFF;
      box-shadow: 0 10px 22px rgba(2, 54, 83, 0.45);
    }

    .btn-primary:hover {
      filter: brightness(1.04);
      box-shadow: 0 12px 26px rgba(2, 54, 83, 0.55);
    }

    .btn-sm {
      padding: 6px 10px;
      font-size: 0.78rem;
    }

    /* PROFILE BUTTON */
    .profile-button {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      background: #FFFFFF;
      border: 1px solid var(--border-subtle);
      box-shadow: 0 6px 16px rgba(2, 54, 83, 0.08);
      transition:
        background 0.16s ease,
        box-shadow 0.16s ease,
        transform 0.12s ease,
        border-color 0.12s ease;
    }

    .profile-button:hover {
      background: var(--card-soft);
      border-color: var(--accent-soft);
      box-shadow: 0 10px 22px rgba(2, 54, 83, 0.16);
      transform: translateY(-1px);
    }

    .avatar-wrap {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      overflow: hidden;
      background: #D1D5DB;
      flex-shrink: 0;
    }

    .avatar-wrap img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .gear-icon {
      font-size: 18px;
      color: var(--accent);
    }

    /* SECTION WRAPPER */
    .section-shell {
      padding: 0 24px 26px;
      width: 100%;
    }

    @media (max-width: 900px) {
      .section-shell { padding: 0 18px 22px; }
    }
  
    /* HERO ROW */
    .hero-row {
      margin-top: 6px;
      display: grid;
      grid-template-columns: minmax(0, 2.1fr) minmax(0, 1.7fr);
      gap: 20px;
      margin-bottom: 24px;
    }

    @media (max-width: 1024px) {
      .hero-row { grid-template-columns: minmax(0,1fr); }
    }

    .hero-card {
      position: relative;
      border-radius: var(--radius-lg);
      padding: 20px 22px 18px;
      background: #FFFFFF;
      border: 1px solid var(--border-subtle);
      box-shadow: var(--shadow-soft);
    }

    .hero-card h2 {
      margin: 0 0 6px;
      font-size: 1.2rem;
      color: var(--accent-strong);
    }

    .hero-card p {
      margin: 0;
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .hero-pills {
      margin-top: 12px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      font-size: 0.76rem;
    }

    .hero-pill {
      padding: 6px 10px;
      border-radius: var(--radius-pill);
      border: 1px solid var(--border-subtle);
      background: var(--card-soft);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: var(--text-main);
    }

    .hero-actions {
      margin-top: 14px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    /* CALENDAR CARD */
    .calendar-card {
      position: relative;
      border-radius: var(--radius-lg);
      padding: 18px 18px 14px;
      background: var(--card);
      border: 1px solid var(--border-subtle);
      box-shadow: var(--shadow-soft);
    }

    .calendar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 10px;
    }

    .calendar-header h3 {
      margin: 0;
      font-size: 0.98rem;
      color: var(--accent-strong);
    }

    .calendar-header p {
      margin: 2px 0 0;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .calendar-controls {
      display: inline-flex;
      gap: 4px;
      font-size: 0.8rem;
    }

    .calendar-controls button {
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: #F6F9FB;
      padding: 3px 9px;
      font-size: 0.78rem;
      color: var(--text-main);
      transition:
        background 0.16s ease,
        border-color 0.16s ease,
        transform 0.12s ease,
        box-shadow 0.12s ease;
    }

    .calendar-controls button:hover {
      background: var(--card-soft);
      border-color: var(--accent-soft);
      transform: translateY(-1px);
      box-shadow: 0 6px 14px rgba(2, 54, 83, 0.16);
    }

    .calendar-grid {
      margin-top: 4px;
      display: grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      gap: 4px;
      font-size: 0.72rem;
    }

    .calendar-day-header {
      text-align: center;
      font-weight: 600;
      color: #94A4B2;
      padding-bottom: 2px;
    }

    .calendar-day {
      position: relative;
      border-radius: 10px;
      padding: 6px 5px 16px;
      text-align: left;
      cursor: pointer;
      border: 1px solid #D7E1EA;
      background: #FFFFFF;
      min-height: 42px;
      display: flex;
      flex-direction: column;
      gap: 2px;
      transition:
        background 0.16s ease,
        border-color 0.16s ease,
        box-shadow 0.16s ease,
        transform 0.12s ease;
      color: var(--text-main);
    }

    .calendar-day span {
      font-size: 0.8rem;
      font-weight: 600;
    }

    .calendar-day:hover {
      border-color: var(--accent-soft);
      background: var(--card-soft);
      box-shadow: 0 6px 16px rgba(2, 54, 83, 0.16);
      transform: translateY(-1px);
    }

    .calendar-day.is-today {
      border-color: var(--accent);
      background: var(--card-soft);
      box-shadow: 0 0 0 1px rgba(5, 108, 137, 0.35);
    }

    .calendar-day.is-selected {
      border-color: var(--accent-strong);
      background: #D6F0FA;
      box-shadow: 0 0 0 1px rgba(2, 54, 83, 0.4);
    }

    .calendar-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--accent);
      position: absolute;
      bottom: 5px;
      left: 6px;
    }

    .calendar-dot.goal {
      background: var(--accent-strong);
      left: 14px;
    }

    .calendar-footer {
      margin-top: 10px;
      padding-top: 8px;
      border-top: 1px solid #D7E1EA;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    .calendar-streak {
      font-weight: 600;
      color: var(--accent);
    }

    /* STATS ROW */
    .stats-row {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 18px;
      margin-bottom: 24px;
    }

    @media (max-width: 900px) {
      .stats-row { grid-template-columns: repeat(2, minmax(0,1fr)); }
    }
    @media (max-width: 640px) {
      .stats-row { grid-template-columns: minmax(0,1fr); }
    }

    .stat-card {
      position: relative;
      border-radius: 14px;
      padding: 12px 14px;
      background: var(--card);
      border: 1px solid var(--border-subtle);
      box-shadow: var(--shadow-soft);
      overflow: hidden;
      transition: transform 0.16s ease, box-shadow 0.16s ease, border-color 0.16s ease;
    }

    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 16px 32px rgba(2, 54, 83, 0.2);
      border-color: var(--accent-soft);
    }

    .stat-title {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: .08em;
      color: var(--text-muted);
    }

    .stat-value {
      font-size: 1.6rem;
      font-weight: 700;
      margin: 6px 0 3px;
      color: var(--accent-strong);
    }

    .stat-sub {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    /* SECTION HEADER */
    .section-block {
      margin-bottom: 24px;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
      margin: 0 0 10px;
    }

    .section-title {
      margin: 0 0 4px;
      font-size: 1rem;
      font-weight: 600;
      color: var(--accent-strong);
    }

    .section-subtitle {
      margin: 0;
      font-size: 0.82rem;
      color: var(--text-muted);
    }

    /* RECENT ACTIVITY */
    .activity-row {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 18px;
    }

    @media (max-width: 1024px) {
      .activity-row { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }

    @media (max-width: 640px) {
      .activity-row { grid-template-columns: minmax(0,1fr); }
    }

    .activity-card {
      background: var(--card);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-subtle);
      box-shadow: var(--shadow-soft);
      padding: 14px 14px 12px;
      font-size: 0.86rem;
      min-width: 0;
      position: relative;
      overflow: hidden;
      transition:
        transform 0.16s ease,
        box-shadow 0.16s ease,
        border-color 0.16s ease,
        background 0.16s ease;
    }

    .activity-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 16px 32px rgba(2, 54, 83, 0.2);
      border-color: var(--accent-soft);
      background: #FFFFFF;
    }

    .activity-card h3 {
      display: flex;
      align-items: center;
      gap: 6px;
      margin: 0 0 8px;
      font-size: 0.95rem;
      color: var(--accent-strong);
    }

    .activity-icon {
      font-size: 1.1rem;
    }

    /* ITEMS */
    .skill_item,
    .habit_item,
    .reward_item {
      background: var(--card-soft);
      border-radius: 12px;
      padding: 9px 10px;
      margin-bottom: 9px;
      font-size: 0.82rem;
      border: 1px solid #D0DDE5;
      position: relative;
      cursor: pointer;
      color: var(--text-main);
      transition:
        transform 0.12s ease,
        box-shadow 0.12s ease,
        border-color 0.12s ease,
        background 0.12s ease;
    }

    .skill_item:hover,
    .habit_item:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 22px rgba(2, 54, 83, 0.14);
      border-color: var(--accent-soft);
      background: #FFFFFF;
    }

    .skill_head,
    .habit_head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .skill_name,
    .habit_name,
    .reward_name {
      font-weight: 600;
    }

    /* REWARDS (badge styling) */
    .reward_item {
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 6px 14px rgba(2, 54, 83, 0.15);
      overflow: hidden;
      transform: translateY(2px);
    }

    .badge-glow {
      position: absolute;
      inset: 0;
      border-radius: 12px;
      box-shadow: 0 0 0 0 rgba(5, 108, 137, 0.35);
      opacity: 0;
      pointer-events: none;
      transition: box-shadow 0.3s ease, opacity 0.3s ease;
    }

    .badge-icon {
      width: 30px;
      height: 30px;
      border-radius: 999px;
      background: linear-gradient(135deg, #FACC15, #E6A854);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #1F2937;
      font-size: 1.1rem;
      box-shadow: 0 8px 18px rgba(0, 0, 0, 0.35);
      flex-shrink: 0;
    }

    .badge-main {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }

    .badge-title {
      font-weight: 600;
      font-size: 0.82rem;
    }

    .badge-desc {
      font-size: 0.75rem;
      color: var(--text-muted);
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
    }

    .reward_item:hover {
      box-shadow: 0 14px 30px rgba(2, 54, 83, 0.22);
      transform: translateY(-3px);
      border-color: var(--accent-soft);
      background: #FFFFFF;
    }

    .reward_item.unlocked:hover .badge-glow {
      opacity: 1;
      box-shadow:
        0 0 0 1px rgba(5, 108, 137, 0.6),
        0 0 0 8px rgba(5, 108, 137, 0.15);
    }

    .skill_level,
    .habit_percent {
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    .skill_progress_bar,
    .habit_progress_bar {
      position: relative;
      height: 9px;
      background: #D7E1EA;
      border-radius: 999px;
      overflow: hidden;
      margin: 3px 0 3px;
    }

    .skill_progress_fill,
    .habit_progress_fill {
      width: 0;
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--accent-soft));
      border-radius: inherit;
      transition: width 0.4s ease-out;
    }

    .progress-label {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .activity-inspector {
      margin-top: 14px;
      padding: 10px 12px;
      border-radius: 14px;
      background: #E5F3F7;
      border: 1px solid #C4DDE7;
      font-size: 0.82rem;
      color: var(--text-main);
    }

    .activity-inspector-title {
      margin: 0 0 4px;
      font-size: 0.86rem;
      font-weight: 600;
      color: var(--accent-strong);
    }

    .activity-inspector-body {
      margin: 0;
      color: var(--text-muted);
    }

    /* FOCUS ROW */
    .tasks-row {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 18px;
    }

    @media (max-width: 1100px) {
      .tasks-row { grid-template-columns: repeat(2, minmax(0,1fr)); }
    }
    @media (max-width: 640px) {
      .tasks-row { grid-template-columns: minmax(0,1fr); }
    }

    .tasks-card {
      background: var(--card);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-subtle);
      box-shadow: var(--shadow-soft);
      padding: 14px 14px 12px;
      font-size: 0.86rem;
      min-width: 0;
      position: relative;
      overflow: hidden;
      transition:
        transform 0.16s ease,
        box-shadow 0.16s ease,
        border-color 0.16s ease,
        background 0.16s ease;
    }

    .tasks-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 16px 32px rgba(2, 54, 83, 0.2);
      border-color: var(--accent-soft);
    }

    .tasks-card h3 {
      margin: 0 0 8px;
      font-size: 0.95rem;
      color: var(--accent-strong);
    }

    .task_item {
      background: var(--card-soft);
      border-radius: 10px;
      padding: 9px 9px;
      margin-bottom: 9px;
      font-size: 0.82rem;
      border: 1px solid #D0DDE5;
      display: flex;
      flex-direction: column;
      gap: 4px;
      color: var(--text-main);
      transition:
        transform 0.12s ease,
        box-shadow 0.12s ease,
        border-color 0.12s ease,
        background 0.12s ease;
    }

    .task_item:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 22px rgba(2, 54, 83, 0.14);
      border-color: var(--accent-soft);
      background: #FFFFFF;
    }

    .task_head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2px;
    }

    .task_name {
      font-weight: 600;
    }

    .task_status {
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    /* FRIENDS */
    .friend_item {
      background: var(--card-soft);
      border-radius: 10px;
      padding: 8px 9px;
      margin-bottom: 8px;
      font-size: 0.82rem;
      border: 1px solid #D0DDE5;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
      color: var(--text-main);
      transition:
        transform 0.12s ease,
        box-shadow 0.12s ease,
        border-color 0.12s ease,
        background 0.12s ease;
    }

    .friend_item:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 22px rgba(2, 54, 83, 0.14);
      border-color: var(--accent-soft);
      background: #FFFFFF;
    }

    .friend-main {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .friend-avatar {
      width: 24px;
      height: 24px;
      border-radius: 999px;
      background: #D1D5DB;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--accent-strong);
      flex-shrink: 0;
    }

    .friend-name { font-weight: 500; }

    .friend-status {
      font-size: 0.76rem;
      color: var(--accent);
    }

    .friend-status.offline {
      color: var(--text-muted);
    }

    /* MODALS */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.38);
      display: none;
      z-index: 2000;
      align-items: center;
      justify-content: center;
      padding: 16px;
      backdrop-filter: blur(6px);
    }

    .modal-overlay.is-open {
      display: flex;
    }

    .modal {
      width: 380px;
      max-width: 100%;
      background: #FFFFFF;
      border-radius: 18px;
      box-shadow: 0 20px 44px rgba(0, 0, 0, 0.35);
      border: 1px solid #D3DFE8;
      overflow: hidden;
      animation: fadeInUp 0.22s ease-out forwards;
      color: var(--text-main);
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(10px) scale(0.98); }
      to   { opacity: 1; transform: translateY(0) scale(1); }
    }

    .modal-header {
      padding: 12px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(120deg, var(--accent), var(--accent-strong));
      color: #FFFFFF;
    }

    .modal-header h3 {
      margin: 0;
      font-size: 0.96rem;
    }

    .modal-close {
      font-size: 1.4rem;
      line-height: 1;
      background: transparent;
      color: #E5E7EB;
      border: none;
      cursor: pointer;
    }

    .modal-body {
      padding: 12px 16px 16px;
      font-size: 0.9rem;
      background: #F5FAFC;
    }

    .profile-modal-layout {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .profile-card {
      border-radius: 14px;
      border: 1px solid #D3DFE8;
      background: #FFFFFF;
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.12);
      overflow: hidden;
    }

    .profile-card-header {
      position: relative;
      padding: 24px 18px 40px;
      text-align: center;
      color: var(--text-main);
      background: linear-gradient(
        135deg,
        var(--card-soft) 0%,
        #FFFFFF 60%
      );
    }

    .profile-card-header p {
      margin: 0;
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    .profile-card-header h4 {
      margin: 6px 0 0;
      font-size: 1.05rem;
      color: var(--accent-strong);
    }

    .profile-tagline {
      margin-top: 3px;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .profile-avatar-shell {
      position: absolute;
      left: 50%;
      bottom: -28px;
      transform: translateX(-50%);
      width: 70px;
      height: 70px;
      border-radius: 999px;
      border: 3px solid #FFFFFF;
      overflow: hidden;
      background: #D1D5DB;
      box-shadow: 0 10px 24px rgba(0, 0, 0, 0.3);
    }

    .profile-avatar-shell img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .profile-card-main {
      padding: 40px 16px 14px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      background: #FFFFFF;
    }

    .profile-detail-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
      font-size: 0.8rem;
    }

    .profile-detail-item {
      background: #F5FAFC;
      border-radius: 10px;
      padding: 6px 8px;
      border: 1px solid #D3DFE8;
    }

    .profile-detail-label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      margin-bottom: 1px;
    }

    .profile-detail-value {
      font-size: 0.86rem;
      color: var(--text-main);
    }

    .profile-quick-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 4px;
    }

    .p-btn {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #D3DFE8;
      background: #FFFFFF;
      font-size: 0.8rem;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: var(--text-main);
      transition:
        background 0.14s ease,
        border-color 0.14s ease,
        box-shadow 0.14s ease,
        transform 0.14s ease;
    }

    .p-btn-primary {
      background: linear-gradient(120deg, var(--accent), var(--accent-strong));
      color: #FFFFFF;
      border-color: transparent;
      box-shadow: 0 8px 18px rgba(2, 54, 83, 0.5);
    }

    .p-btn-primary:hover {
      filter: brightness(1.05);
      transform: translateY(-1px);
    }

    .p-btn-ghost {
      background: #F5FAFC;
    }

    .p-btn-ghost:hover {
      background: var(--card-soft);
    }

    .p-btn-logout {
      background: #FEE2E2;
      border-color: #FECACA;
      color: #B91C1C;
    }

    .p-btn-logout:hover {
      background: #FECACA;
    }

    .profile-quick-links {
      border-radius: 14px;
      border: 1px solid #D3DFE8;
      background: #FFFFFF;
      padding: 10px 12px;
      font-size: 0.8rem;
      color: var(--text-main);
      box-shadow: 0 10px 22px rgba(0, 0, 0, 0.08);
    }

    .profile-quick-links h4 {
      margin: 0 0 4px;
      font-size: 0.84rem;
      color: var(--accent-strong);
    }

    .profile-quick-links ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .profile-quick-links li + li {
      margin-top: 3px;
    }

    .profile-quick-links a {
      color: var(--accent);
    }

    .profile-quick-links a:hover {
      color: var(--accent-strong);
      text-decoration: underline;
    }

    .profile-footnote {
      font-size: 0.78rem;
      color: var(--text-muted);
      margin-top: 6px;
    }

    /* ENTRANCE ANIMATIONS */
    @keyframes fadeInSoft {
      from { opacity: 0; transform: translateY(10px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .fade-in {
      animation: fadeInSoft 0.35s ease-out forwards;
      opacity: 0;
    }

    .delay-1 { animation-delay: .06s; }
    .delay-2 { animation-delay: .12s; }
    .delay-3 { animation-delay: .18s; }
    .delay-4 { animation-delay: .24s; }
  </style>
</head>

<body>
<div class="app-shell">
  <!-- SIDEBAR -->
  <nav class="sidebar" role="navigation" aria-label="Sidebar">
    <div class="brand">
      <div class="brand-mark">CB</div>
      <div class="brand-text">
        <div class="brand-title">Calibration</div>
        <div class="brand-subtitle">Discipline ‚Ä¢ Habits ‚Ä¢ Skills</div>
      </div>
    </div>

    <div class="nav">
      <a href="{% url 'dashboard' %}" class="nav-link active"><span>Dashboard</span></a>
      <a href="{% url 'disciplinebuilder' %}" class="nav-link"><span>Discipline Builder</span></a>
      <a href="{% url 'progresstracker' %}" class="nav-link"><span>Progress Tracker</span></a>
      <a href="{% url 'rewards' %}" class="nav-link"><span>Rewards</span></a>
      <a href="{% url 'coaching' %}" class="nav-link"><span>Coaching</span></a>
      <a href="{% url 'messages' %}" class="nav-link{% if has_unread_messages %} has-unread{% endif %}"><span>Messages</span></a>
      <a href="{% url 'user_profile' %}" class="nav-link"><span>Profile</span></a>
      <a href="{% url 'community' %}" class="nav-link"><span>Community</span></a>
      <a href="{% url 'groups' %}" class="nav-link"><span>Groups</span></a>
    </div>
  </nav>

  <!-- MAIN -->
  <main class="site-main">
    <header class="site-header">
      <div class="site-header-title">
        <h1>Dashboard</h1>
        <span>Your centralized snapshot of habits, skills, tasks, and goals.</span>
      </div>
      <div class="header-actions">
        <div class="toolbar">
          <button class="profile-button" id="profile-button">
            <span class="avatar-wrap">
              <img src="https://via.placeholder.com/40x40.png" alt="User avatar">
            </span>
            <span class="gear-icon">‚öôÔ∏è</span>
          </button>
          <a class="btn btn-primary" href="/accounts/logout/">Log out</a>
        </div>
      </div>
    </header>

    <div class="site-main-inner">
      <!-- PROFILE MODAL -->
      <div class="modal-overlay" id="profile-modal" aria-hidden="true">
        <div class="modal">
          <div class="modal-header">
            <h3>Profile & Account</h3>
            <button type="button" class="modal-close" id="modal-close">&times;</button>
          </div>

          <div class="modal-body">
            <div class="profile-modal-layout">
              <article class="profile-card">
                <div class="profile-card-header">
                  <p>Welcome back</p>
                  <h4>{{ user.username }}</h4>
                  <p class="profile-tagline">Manage your Calibration account and shortcuts.</p>
                  <div class="profile-avatar-shell">
                    <img src="https://via.placeholder.com/80"
                         alt="Avatar for {{ user.username }}">
                  </div>
                </div>
                <div class="profile-card-main">
                  <div class="profile-detail-grid">
                    <div class="profile-detail-item">
                      <div class="profile-detail-label">Account</div>
                      <div class="profile-detail-value">Calibration Basic</div>
                    </div>
                    <div class="profile-detail-item">
                      <div class="profile-detail-label">Email</div>
                      <div class="profile-detail-value">
                        {{ user.email|default:"Not set" }}
                      </div>
                    </div>
                    <div class="profile-detail-item">
                      <div class="profile-detail-label">Member since</div>
                      <div class="profile-detail-value">
                        {{ user.date_joined|date:"M j, Y" }}
                      </div>
                    </div>
                    <div class="profile-detail-item">
                      <div class="profile-detail-label">Last login</div>
                      <div class="profile-detail-value">
                        {{ user.last_login|date:"M j, Y" }}
                      </div>
                    </div>
                  </div>

                  <div class="profile-quick-actions">
                    <a href="{% url 'user_profile' %}" class="p-btn p-btn-primary">View profile</a>
                    <a href="{% url 'user_settings' %}" class="p-btn p-btn-ghost">Account settings</a>
                    <a href="/accounts/logout/" class="p-btn p-btn-logout">Log out</a>
                  </div>
                </div>
              </article>

              <section class="profile-quick-links">
                <h4>Shortcuts</h4>
                <ul>
                  <li><a href="{% url 'skill_create' %}">Add a new skill</a></li>
                  <li><a href="{% url 'habit_create' %}">Create a new habit</a></li>
                  <li><a href="{% url 'rewards' %}">View your rewards</a></li>
                </ul>
                <p class="profile-footnote">
                  Use the dashboard for day-to-day tracking; this space is for account details.
                </p>
              </section>
            </div>
          </div>
        </div>
      </div>

      <!-- DAY DETAIL MODAL -->
      <div class="modal-overlay" id="day-modal" aria-hidden="true">
        <div class="modal">
          <div class="modal-header">
            <h3 id="day-modal-title">Day details</h3>
            <button type="button" class="modal-close" id="day-modal-close">&times;</button>
          </div>
          <div class="modal-body">
            <div id="day-modal-content" style="font-size:0.88rem;">
              <!-- Filled dynamically -->
            </div>
          </div>
        </div>
      </div>

      <!-- HERO + CALENDAR -->
      <section class="section-shell">
        <div class="hero-row">
          <article class="hero-card fade-in delay-1">
            <div>
              <h2>Welcome, {{ user.username }} üëã</h2>
              <p>
                This dashboard gives you a calm overview: skills you‚Äôre leveling,
                habits you‚Äôre building, and tasks that move your goals forward.
              </p>
              <div class="hero-pills">
                <div class="hero-pill">
                  <span>üìà</span>
                  <span>Track growth with clean stats</span>
                </div>
                <div class="hero-pill">
                  <span>‚úÖ</span>
                  <span>See what matters today at a glance</span>
                </div>
              </div>
            </div>
            <div class="hero-actions">
              <a class="btn btn-primary btn-sm" href="{% url 'skill_create' %}">+ New Skill</a>
              <a class="btn btn-sm" href="{% url 'habit_create' %}">+ New Habit</a>
            </div>
          </article>

          <article class="calendar-card fade-in delay-2">
            <div class="calendar-header">
              <div>
                <h3>Weekly Timeline</h3>
                <p>Click a day to see its scheduled tasks and goals.</p>
              </div>
              <div class="calendar-controls">
                <button type="button" id="prev-week">&lt;</button>
                <button type="button" id="next-week">&gt;</button>
              </div>
            </div>

            <div class="calendar-grid" id="calendar-grid">
              <div class="calendar-day-header">S</div>
              <div class="calendar-day-header">M</div>
              <div class="calendar-day-header">T</div>
              <div class="calendar-day-header">W</div>
              <div class="calendar-day-header">T</div>
              <div class="calendar-day-header">F</div>
              <div class="calendar-day-header">S</div>
            </div>

            <div class="calendar-footer">
              <span id="calendar-summary">
                Select a day to see its tasks and goals.
              </span>
              <span class="calendar-streak">
                üî• Streak: {{ xp_today|default:0|yesno:"Active,Starting" }}
              </span>
            </div>
          </article>
        </div>
      </section>

      <!-- STATS -->
      <section class="section-shell">
        <div class="section-block">
          <div class="stats-row">
            <div class="stat-card fade-in delay-1">
              <p class="stat-title">XP Today</p>
              <p class="stat-value" data-count="{{ xp_today|default:0 }}">{{ xp_today|default:0 }}</p>
              <p class="stat-sub">How much progress you logged today.</p>
            </div>
            <div class="stat-card fade-in delay-2">
              <p class="stat-title">XP This Week</p>
              <p class="stat-value" data-count="{{ xp_week|default:0 }}">{{ xp_week|default:0 }}</p>
              <p class="stat-sub">Momentum across the current week.</p>
            </div>
            <div class="stat-card fade-in delay-3">
              <p class="stat-title">Active Goals</p>
              <p class="stat-value" data-count="{{ current_goals|length|default:0 }}">{{ current_goals|length|default:0 }}</p>
              <p class="stat-sub">Long-term objectives currently in motion.</p>
            </div>
            <div class="stat-card fade-in delay-4">
              <p class="stat-title">Open Tasks</p>
              <p class="stat-value" data-count="{{ current_task|length|default:0 }}">{{ current_task|length|default:0 }}</p>
              <p class="stat-sub">Side quests waiting for attention.</p>
            </div>
          </div>
        </div>
      </section>

      <!-- RECENT ACTIVITY -->
      <section class="section-shell">
        <div class="section-block fade-in delay-2">
          <div class="section-header">
            <div>
              <h3 class="section-title">Recent Activity</h3>
              <p class="section-subtitle">
                The latest changes to your skills, habits, and badges.
              </p>
            </div>
          </div>

          <div class="activity-row">
            <!-- Skills -->
            <article class="activity-card">
              <h3><span class="activity-icon">üß©</span> Skills</h3>
              {% for x in latest_skills %}
                <div class="skill_item">
                  <div class="skill_head">
                    <span class="skill_name">{{ x.name }}</span>
                    <span class="skill_level">Lv. {{ x.level }}</span>
                  </div>

                  <div class="skill_progress_bar">
                    <div class="skill_progress_fill" style="width: {{ x.skill_progress_tracked|default:0 }}%;"></div>
                  </div>

                  <small class="progress-label">
                    {{ x.xp }} / {{ x.to_level_up }} XP ¬∑ {{ x.left_over }} XP to next level
                  </small>
                </div>
              {% empty %}
                <p class="muted">No skill activity yet. Create your first skill to start tracking.</p>
              {% endfor %}
            </article>

            <!-- Habits -->
            <article class="activity-card">
              <h3><span class="activity-icon">üå±</span> Habits</h3>
              {% for m in recent_habits %}
                <div class="habit_item">
                  <div class="habit_head">
                    <span class="habit_name">{{ m.name }}</span>
                    <span class="habit_percent">{{ m.goal_percentage|default:0 }}%</span>
                  </div>

                  <div class="habit_progress_bar">
                    <div class="habit_progress_fill" style="width: {{ m.goal_percentage|default:0 }}%;"></div>
                  </div>

                  <small class="progress-label">
                    {{ m.days_left }} day(s) left in this habit window.
                  </small>
                </div>
              {% empty %}
                <p class="muted">No habit activity yet. Build or break your first habit.</p>
              {% endfor %}
            </article>

            <!-- Rewards -->
            <article class="activity-card">
              <h3><span class="activity-icon">üèÜ</span> Rewards</h3>
              {% for r in recent_badges %}
                <div class="reward_item unlocked">
                  <div class="badge-glow"></div>

                  <div class="badge-icon">
                    üéñÔ∏è
                  </div>

                  <div class="badge-main">
                    <div class="badge-title">
                      {{ r.badge.title }}
                    </div>

                    {% if r.badge.description %}
                      <div class="badge-desc">
                        {{ r.badge.description }}
                      </div>
                    {% endif %}
                  </div>
                </div>
              {% empty %}
                <p class="muted">
                  No badges yet. Complete tasks, habits, and skills to earn your first one.
                </p>
              {% endfor %}
            </article>
          </div>

          <div class="activity-inspector" id="activity-inspector">
            <p class="activity-inspector-title">Item details</p>
            <p class="activity-inspector-body">
              Click a skill or habit card to see a quick summary here.
            </p>
          </div>
        </div>
      </section>

      <!-- FOCUS -->
      <section class="section-shell">
        <div class="section-block fade-in delay-3">
          <div class="section-header">
            <div>
              <h3 class="section-title">Focus</h3>
              <p class="section-subtitle">What you can move forward right now.</p>
            </div>
          </div>

          <div class="tasks-row">
            <!-- Tasks -->
            <article class="tasks-card">
              <h3>Current Tasks</h3>
              {% for t in current_task %}
                <div class="task_item">
                  <div class="task_head">
                    <span class="task_name">{{ t.title }}</span>
                    <span class="task_status">{{ t.status }}</span>
                  </div>
                  <div style="display:flex; gap:6px; flex-wrap:wrap; margin-top:6px;">
                    <form method="post" action="{% url 'task_complete' t.id %}">
                      {% csrf_token %}
                      <button class="btn btn-primary btn-sm" type="submit">Mark complete</button>
                    </form>
                    <a class="btn btn-sm" href="{% url 'task_update' t.id %}">Edit</a>
                  </div>
                </div>
              {% empty %}
                <p class="muted">No tasks assigned yet. Create tasks on the Discipline Builder page.</p>
              {% endfor %}
            </article>

            <!-- Goals -->
            <article class="tasks-card">
              <h3>Current Goals</h3>
              {% for cg in current_goals %}
                <div class="task_item">
                  <div class="task_head">
                    <span class="task_name">{{ cg.title }}</span>
                    <span class="task_status">{{ cg.status }}</span>
                  </div>
                  <div style="display:flex; gap:6px; flex-wrap:wrap; margin-top:6px;">
                    <form method="post" action="{% url 'goal_complete' cg.id %}">
                      {% csrf_token %}
                      <button class="btn btn-primary btn-sm" type="submit">Mark complete</button>
                    </form>
                    <a class="btn btn-sm" href="{% url 'goal_update' cg.id %}">Edit</a>
                  </div>
                </div>
              {% empty %}
                <p class="muted">No goals yet. Set goals to give your habits and skills direction.</p>
              {% endfor %}
            </article>

            <!-- Current Groups -->
            <article class="tasks-card">
              <div style="display:flex; justify-content:space-between; align-items:center; gap:8px;">
                <h3 style="margin:0;">Current Groups</h3>
                <a class="btn btn-sm" href="{% url 'groups' %}">Open groups</a>
              </div>
              {% if my_groups %}
                {% for g in my_groups %}
                  <div class="task_item">
                    <div class="task_head">
                      <span class="task_name">{{ g.name }}</span>
                      <span class="task_status">{{ g.category|default:"Group" }}</span>
                    </div>
                    <p class="muted" style="margin:4px 0 0;">
                      {{ g.member_count|default:0 }} member(s)
                    </p>
                  </div>
                {% endfor %}
              {% else %}
                <p class="muted">You‚Äôre not in any groups yet. Join or create one from the Groups page.</p>
              {% endif %}
            </article>

            <!-- Friends -->
            <article class="tasks-card">
              <h3>Friends</h3>
              {% for f in friends %}
                <div class="friend_item">
                  <div class="friend-main">
                    <div class="friend-avatar">
                      {{ f.username|first|upper }}
                    </div>
                    <div class="friend-name">{{ f.username }}</div>
                  </div>
                  <div class="friend-status {% if not f.is_online %}offline{% endif %}">
                    {% if f.is_online %}‚óè Online{% else %}‚óè Offline{% endif %}
                  </div>
                </div>
              {% empty %}
                <p class="muted">
                  You haven't added any friends yet. Invite someone from the Community or Messages pages.
                </p>
              {% endfor %}
            </article>
          </div>
        </div>
      </section>
    </div>
  </main>
</div>

<!-- CALENDAR + PROGRESS + INSPECTOR + COUNTERS JS -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const grid = document.getElementById("calendar-grid");
    const summary = document.getElementById("calendar-summary");
    const prevBtn = document.getElementById("prev-week");
    const nextBtn = document.getElementById("next-week");
    const events = JSON.parse('{{ calendar_events_json|default:"{}"|escapejs }}');

    const dayModal = document.getElementById("day-modal");
    const dayModalClose = document.getElementById("day-modal-close");
    const dayModalTitle = document.getElementById("day-modal-title");
    const dayModalContent = document.getElementById("day-modal-content");

    if (!grid || !summary) return;

    let currentOffset = 0;

    function startOfWeek(date) {
      const d = new Date(date);
      const day = d.getDay();
      d.setDate(d.getDate() - day);
      d.setHours(0, 0, 0, 0);
      return d;
    }

    function formatShort(d) {
      return d.toLocaleDateString(undefined, { month: "short", day: "numeric" });
    }

    function formatFull(d) {
      return d.toLocaleDateString(undefined, {
        weekday: "long",
        month: "short",
        day: "numeric",
        year: "numeric"
      });
    }

    function openDayModal(dayDate, dayEvents) {
      if (!dayModal || !dayModalTitle || !dayModalContent) return;

      dayModalTitle.textContent = formatFull(dayDate);

      let html = "";

      if (!dayEvents) {
        html = "<p>No events scheduled for this day.</p>";
      } else {
        if (Array.isArray(dayEvents.items)) {
          html += "<ul style='padding-left: 1.1rem; margin: 0;'>";
          dayEvents.items.forEach(function (evt) {
            const title = evt.title || "Event";
            const time = evt.time ? `<strong>${evt.time}</strong> ‚Äì ` : "";
            const desc = evt.description ? `<br><span class='muted'>${evt.description}</span>` : "";
            html += `<li style="margin-bottom: 6px;">${time}${title}${desc}</li>`;
          });
          html += "</ul>";
        } else {
          const tasks = (typeof dayEvents.tasks === "number") ? dayEvents.tasks : (dayEvents.tasks || 0);
          const goals = (typeof dayEvents.goals === "number") ? dayEvents.goals : (dayEvents.goals || 0);

          html += `<p><strong>${tasks}</strong> task(s) and <strong>${goals}</strong> goal(s) scheduled.</p>`;

          if (Array.isArray(dayEvents.tasks_detail) && dayEvents.tasks_detail.length) {
            html += "<h4 style='margin: 8px 0 4px; font-size:0.86rem;'>Tasks</h4><ul style='padding-left:1.1rem; margin:0;'>";
            dayEvents.tasks_detail.forEach(function (t) {
              const title = t.title || "Task";
              const status = t.status ? ` <span class='muted'>(${t.status})</span>` : "";
              html += `<li style="margin-bottom:4px;">${title}${status}</li>`;
            });
            html += "</ul>";
          }

          if (Array.isArray(dayEvents.goals_detail) && dayEvents.goals_detail.length) {
            html += "<h4 style='margin: 8px 0 4px; font-size:0.86rem;'>Goals</h4><ul style='padding-left:1.1rem; margin:0;'>";
            dayEvents.goals_detail.forEach(function (g) {
              const title = g.title || "Goal";
              const status = g.status ? ` <span class='muted'>(${g.status})</span>` : "";
              html += `<li style="margin-bottom:4px;">${title}${status}</li>`;
            });
            html += "</ul>";
          }
        }
      }

      dayModalContent.innerHTML = html;
      dayModal.classList.add("is-open");
      dayModal.setAttribute("aria-hidden", "false");
    }

    function closeDayModal() {
      if (!dayModal) return;
      dayModal.classList.remove("is-open");
      dayModal.setAttribute("aria-hidden", "true");
    }

    function renderWeek(offset) {
      const headers = Array.from(grid.querySelectorAll(".calendar-day-header"));
      grid.innerHTML = "";
      headers.forEach(h => grid.appendChild(h));

      const today = new Date();
      const base = startOfWeek(new Date());
      base.setDate(base.getDate() + offset * 7);

      for (let i = 0; i < 7; i++) {
        const dayDate = new Date(base);
        dayDate.setDate(base.getDate() + i);
        const dayKey = dayDate.toISOString().slice(0, 10);
        const dayEvents = events[dayKey];

        const cell = document.createElement("button");
        cell.type = "button";
        cell.className = "calendar-day";
        cell.dataset.date = dayDate.toISOString();

        if (dayDate.toDateString() === today.toDateString() && offset === 0) {
          cell.classList.add("is-today");
        }

        const label = document.createElement("span");
        label.textContent = dayDate.getDate();
        cell.appendChild(label);

        if (dayEvents && dayEvents.tasks) {
          const dotTask = document.createElement("div");
          dotTask.className = "calendar-dot";
          cell.appendChild(dotTask);
        }
        if (dayEvents && dayEvents.goals) {
          const dotGoal = document.createElement("div");
          dotGoal.className = "calendar-dot goal";
          cell.appendChild(dotGoal);
        }

        cell.addEventListener("click", () => {
          const niceDate = formatShort(dayDate);
          if (dayEvents) {
            summary.textContent = `${niceDate}: ${dayEvents.tasks} task(s), ${dayEvents.goals} goal(s).`;
          } else {
            summary.textContent = `${niceDate}: nothing scheduled.`;
          }

          grid.querySelectorAll(".calendar-day").forEach(d => d.classList.remove("is-selected"));
          cell.classList.add("is-selected");

          openDayModal(dayDate, dayEvents);
        });

        grid.appendChild(cell);
      }
    }

    renderWeek(currentOffset);

    if (prevBtn) {
      prevBtn.addEventListener("click", () => {
        currentOffset -= 1;
        renderWeek(currentOffset);
      });
    }
    if (nextBtn) {
      nextBtn.addEventListener("click", () => {
        currentOffset += 1;
        renderWeek(currentOffset);
      });
    }

    if (dayModalClose) {
      dayModalClose.addEventListener("click", closeDayModal);
    }
    if (dayModal) {
      dayModal.addEventListener("click", function (e) {
        if (e.target === dayModal) closeDayModal();
      });
    }
    document.addEventListener("keydown", function (e) {
      if (e.key === "Escape" && dayModal && dayModal.classList.contains("is-open")) {
        closeDayModal();
      }
    });

    // Animate progress bars
    const fills = document.querySelectorAll(".skill_progress_fill, .habit_progress_fill");
    fills.forEach(fill => {
      const width = fill.getAttribute("style");
      fill.setAttribute("style", "width:0");
      requestAnimationFrame(() => {
        fill.setAttribute("style", width);
      });
    });

    // Activity inspector
    const inspector = document.getElementById("activity-inspector");
    if (inspector) {
      const titleEl = inspector.querySelector(".activity-inspector-title");
      const bodyEl = inspector.querySelector(".activity-inspector-body");
      const items = document.querySelectorAll(".skill_item, .habit_item");

      items.forEach(item => {
        item.addEventListener("click", () => {
          const nameEl = item.querySelector(".skill_name, .habit_name");
          const label = nameEl ? nameEl.textContent.trim() : "Selected item";
          titleEl.textContent = label;
          bodyEl.textContent = item.innerText.trim();
        });
      });
    }

    // Animated stat counters
    const counters = document.querySelectorAll(".stat-value[data-count]");
    counters.forEach(counter => {
      const target = parseInt(counter.dataset.count || "0", 10);
      const startValue = 0;
      const duration = 800;
      const startTime = performance.now();

      function update(now) {
        const elapsed = now - startTime;
        const progress = Math.min(elapsed / duration, 1);
        const value = Math.floor(startValue + (target - startValue) * progress);
        counter.textContent = value;
        if (progress < 1) requestAnimationFrame(update);
      }
      requestAnimationFrame(update);
    });

    // Trigger fade-in classes
    const fadeEls = document.querySelectorAll(".fade-in");
    fadeEls.forEach(el => {
      void el.offsetWidth;
      el.style.opacity = "1";
    });
  });
</script>

<!-- PROFILE MODAL JS -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const profilePill = document.getElementById("profile-button");
    const modal = document.getElementById("profile-modal");
    const closeBtn = document.getElementById("modal-close");

    if (!profilePill || !modal || !closeBtn) return;

    function openModal() {
      modal.classList.add("is-open");
      modal.setAttribute("aria-hidden", "false");
    }

    function closeModal() {
      modal.classList.remove("is-open");
      modal.setAttribute("aria-hidden", "true");
    }

    profilePill.addEventListener("click", openModal);
    closeBtn.addEventListener("click", closeModal);

    modal.addEventListener("click", function (e) {
      if (e.target === modal) closeModal();
    });

    document.addEventListener("keydown", function (e) {
      if (e.key === "Escape" && modal.classList.contains("is-open")) {
        closeModal();
      }
    });
  });
</script>

</body>
</html>
