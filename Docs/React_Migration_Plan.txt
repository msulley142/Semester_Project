React Migration Plan for Calibration

Goal
-----
Move the current Django template–based UI to a React single‑page application (SPA), keeping Django for models, authentication, and APIs. Deliver this incrementally so the app remains usable while we migrate page by page.

Why This Approach
-----------------
- Preserve backend logic and data: Reuse existing Django models, auth, and business rules.
- Improve UI velocity: React enables richer UX and faster iteration.
- Reduce risk: Phase migration lets us ship small, testable slices instead of a big bang rewrite.

High‑Level Strategy (Phases)
----------------------------
0) Preflight
   - Confirm local dev runs: Django at http://127.0.0.1:8000.
   - Decide on auth for the SPA during dev: session+CSRF (same domain) or JWT.

1) API Foundation (Django + DRF)
   - Add DRF serializers for core models: Skill, Habit, Task, Journal, Reward, Profile, User_Badge.
   - Add DRF ViewSets that scope all queries by `account_user=self.request.user`.
   - Add a DRF router under `/api/` in `calibrationapi/urls.py`.
   - Add CORS for dev (django-cors-headers) and keep strict origins in prod.
   Why: A clean, typed API surface makes the React app straightforward and keeps server logic centralized and secure.

2) React App Setup
   - Create `Semester_Project/frontend` using Vite (React template) for fast DX.
   - Install `axios` and `react-router-dom`.
   - Configure Vite dev proxy so `/api` calls hit Django at `http://127.0.0.1:8000`.
   - Add a basic route skeleton mapping current pages.
   Why: Vite is modern and fast; proxy eliminates CORS pain in dev.

3) Page‑by‑Page Migration
   - Map old templates → new React routes:
     • `/` → Home (copy content from `templates/index.html`).
     • `/dashboard` → data from new endpoints (latest skills, habits, badges, tasks).
     • `/disciplinebuilder` → CRUD for Skill, Habit, plus Task/Journal create.
     • `/progresstracker`, `/rewards`, `/community`, `/coaching`, `/messages` → matching routes.
   - For Dashboard data, prefer a small aggregated backend endpoint to avoid N calls and preserve existing logic.
   Why: Incremental swapping lets users keep working and reduces integration risk.

4) Retire Django Templates
   - Replace Django root route to serve built React `index.html` (WhiteNoise or static files) or let the SPA host own `/` in split deployment.
   - Delete each template once its React counterpart ships.
   - Remove form‑based CBVs and their templates; keep API ViewSets instead.
   - Remove `crispy_forms`, `crispy_tailwind`, and `widget_tweaks` after all server forms are gone.
   Why: Avoid duplicated UI paths and maintenance once React is live.

5) Deployment Options
   Option A: Single domain (recommended to start)
     - Dev: run Django and React dev server with proxy.
     - Prod: `npm run build` and serve `frontend/dist` from Django with WhiteNoise; add a catch‑all to serve `index.html`.
   Option B: Split front/back
     - Deploy React (Vercel/Netlify) and Django elsewhere; enable CORS and use JWT for auth.
   Why: Single domain simplifies auth & CSRF; split hosting is fine if you prefer separate pipelines.

6) Testing & Validation
   - API: add minimal tests for auth scoping (user only sees their own data).
   - UI: smoke tests for critical flows (login, dashboard load, CRUD Skill/Habit/Task/Journal).
   - Manual: verify CSRF/JWT flows and navigation.
   Why: Catch regressions early and ensure user data isolation.

Concrete Backend Changes
------------------------
Files to add:
1) `calibration_app/serializers.py`
   Example:
   from rest_framework import serializers
   from .models import Skill, Habit, Task, Journal, Reward, User_Badge, Profile

   class SkillSerializer(serializers.ModelSerializer):
       class Meta:
           model = Skill
           fields = "__all__"

   # Repeat similarly for Habit, Task, Journal, Reward, User_Badge, Profile

2) `calibration_app/api.py` (ViewSets)
   from rest_framework.viewsets import ModelViewSet
   from rest_framework.permissions import IsAuthenticated
   from .models import Skill, Habit, Task, Journal, Reward, User_Badge
   from .serializers import SkillSerializer, HabitSerializer, TaskSerializer, JournalSerializer, RewardSerializer, UserBadgeSerializer

   class UserScopedMixin:
       def get_queryset(self):
           qs = super().get_queryset()
           if hasattr(qs.model, "account_user"):
               return qs.filter(account_user=self.request.user)
           return qs
       def perform_create(self, serializer):
           if "account_user" in serializer.fields or hasattr(serializer.Meta.model, "account_user"):
               serializer.save(account_user=self.request.user)
           else:
               serializer.save()

   class SkillViewSet(UserScopedMixin, ModelViewSet):
       queryset = Skill.objects.all()
       serializer_class = SkillSerializer
       permission_classes = [IsAuthenticated]

   # Repeat for HabitViewSet, TaskViewSet, JournalViewSet, RewardViewSet

3) Wire router in `calibrationapi/urls.py`
   from rest_framework.routers import DefaultRouter
   from calibration_app.api import SkillViewSet, HabitViewSet, TaskViewSet, JournalViewSet, RewardViewSet
   router = DefaultRouter()
   router.register(r"skills", SkillViewSet)
   router.register(r"habits", HabitViewSet)
   router.register(r"tasks", TaskViewSet)
   router.register(r"journals", JournalViewSet)
   router.register(r"rewards", RewardViewSet)
   urlpatterns = [
       # ... existing
       path("api/", include(router.urls)),
   ]

4) Add CORS (dev)
   - pip install django-cors-headers
   - INSTALLED_APPS += ["corsheaders"]
   - MIDDLEWARE insert: "corsheaders.middleware.CorsMiddleware" near top
   - Dev setting: CORS_ALLOW_ALL_ORIGINS = True (or set CORS_ALLOWED_ORIGINS=[...])

5) Auth choice
   - Same domain (simplest): keep Django session auth; ensure CSRF cookie is set and React sends `X-CSRFToken` on POST/PUT/DELETE.
   - JWT: install `djangorestframework-simplejwt`; add `/api/token/` + `/api/token/refresh/` and send `Authorization: Bearer <token>` from React.

Concrete Frontend Changes
-------------------------
Directory: `Semester_Project/frontend`
Commands:
  npm create vite@latest frontend -- --template react
  cd frontend && npm install
  npm install axios react-router-dom

Vite proxy (vite.config.js):
  server: { proxy: { "/api": { target: "http://127.0.0.1:8000", changeOrigin: true } } }

Route skeleton (src/main.jsx + src/App.jsx):
  - `/` → Home
  - `/dashboard` → Dashboard
  - `/disciplinebuilder` → SkillBuilder
  - `/progresstracker`, `/rewards`, `/community`, `/coaching`, `/messages`

API client (src/api/client.ts):
  - axios instance: baseURL = "/api"; withCredentials = true (if session auth)
  - CSRF helper: read `csrftoken` from cookie; set `X-CSRFToken` on mutating requests

Mapping Old → New
-----------------
Home (templates/index.html):
  - Copy hero markup and styles into a React component; clean duplicate `<html>`/`</style>` tags from the source.

Dashboard (dashboard.html):
  - Backend: add `/api/dashboard/summary/` returning latest skills, recent habits, recent badges, current tasks for current user.
  - Frontend: fetch once, render cards. Avoid N separate requests.

Discipline Builder (skillbuilder.html):
  - Backend: ViewSets above; or a helper endpoint to compute skill progress and habit goal metadata similar to existing context logic.
  - Frontend: forms to create/update/delete Skills/Habits; post to Tasks and Journals.

Other pages: map 1:1 to simple components initially; flesh out features incrementally.

Serving the React Build
-----------------------
Single domain (Django serves build):
  - npm run build → outputs `frontend/dist`
  - Add WhiteNoise; set STATICFILES_DIRS to include `frontend/dist/assets`
  - Add a Django view that returns `frontend/dist/index.html` for any non‑/api path.

Split hosting:
  - Deploy React separately; enable CORS in Django; prefer JWT for auth.

Checklist
---------
[ ] Add serializers.py
[ ] Add api.py (ViewSets)
[ ] Wire DRF router at /api
[ ] Add CORS (dev)
[ ] Scaffold React app (Vite)
[ ] Configure dev proxy (/api → Django)
[ ] Implement Home route (copy landing)
[ ] Add dashboard summary endpoint
[ ] Implement Dashboard UI
[ ] Implement Skill/Habit CRUD
[ ] Implement Task/Journal create
[ ] Serve React build or deploy SPA
[ ] Swap root route to React
[ ] Remove Django templates as migrated
[ ] Remove crispy/forms + widget_tweaks

Dev Workflow
------------
- Backend: cd Semester_Project/calibrationapp && python manage.py runserver
- Frontend: cd Semester_Project/frontend && npm run dev
- Build: cd Semester_Project/frontend && npm run build

Risks & Notes
-------------
- CSRF: For session auth, ensure CSRF cookie is set and forwarded; otherwise use JWT.
- Permissions: All ViewSets must scope by user to prevent data leaks.
- Pagination: Consider enabling DRF pagination as lists grow.
- Dates/TZ: Preserve existing `USE_TZ=True` behavior; send/parse ISO 8601.
- Forms: Removing crispy/forms is safe only after all server forms are gone.

Rollback Plan
-------------
- Keep existing Django templates and routes until each page is confirmed working in React.
- Migrate one route at a time; if issues arise, switch back to the template route temporarily.

